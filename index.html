<!DOCTYPE html>
<!-- saved from url=(0043)file:///I:/%E7%A2%8E%E7%BA%B8%E6%9C%BA.html -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q萌手机-全员ICON自由版</title>
    <style> /* 核心样式 100% 保持不动！就是那么好看！ */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: "PingFang SC","-apple-system", sans-serif; outline: none; }
        body { background-color: #fdf6e3; transition: 0.3s; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .phone-monitor { position: relative; width: 320px; height: 660px; background: #fff; border-radius: 54px; box-shadow: 0 0 0 6px #fff, inset 0 0 10px rgba(0,0,0,0.02), 30px 40px 70px rgba(181, 151, 128, 0.15); overflow: hidden; z-index: 10; }
        .screen-inner { background: #000; width: 100%; height: 100%; position: relative; overflow: hidden; border-radius: 46px; }
        .status-top { position: absolute; top:0; left:0; width:100%; height: 44px; z-index: 999; display: flex; justify-content: space-between; align-items: center; padding: 0 28px; font-size: 13px; font-weight: 600; color: #fff; pointer-events: none; text-shadow:0 1px 2px rgba(0,0,0,0.1); }
        
        .status-right { display: flex; align-items: center; gap: 6px; }
        .battery-icon { width: 22px; height: 11px; border: 1.5px solid rgba(255,255,255,0.9); border-radius: 3px; position: relative; padding: 1px; display: flex; align-items: center; }
        .battery-icon::after { content:''; position: absolute; right: -4px; top: 2px; width: 2px; height: 4px; background: rgba(255,255,255,0.9); border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; width: 60%; background: #fff; border-radius: 1px; }
        
        .signal-icon { display: flex; align-items: flex-end; gap: 2px; height: 11px; margin-right: 2px; }
        .signal-bar { width: 3px; background: rgba(255,255,255,0.4); border-radius: 1px; }
        .signal-bar.active { background: #fff; }

        /* Level 1 Desktop */
        .layer-desktop { position: absolute; top:0; left:0; right:0; bottom:0; padding-top: 60px; overflow: hidden; background: radial-gradient(circle 240px at center, #d8f1f8 0%, #87CEFA 55%, #a2c6ed 100%); background-size: cover; background-position: center; z-index: 1; has-transistion: transform 0.3s; display: flex; flex-direction: column; align-items: center; transition: .3s;}
        .layer-desktop.apps-open { transform: scale(0.92); border-radius: 40px; filter: brightness(0.9);}

        .desktop-content { width:100%; display: flex; flex-direction: column; align-items: center; }
        .widget-clock { font-size: 58px; font-weight: 300; color:#fff; text-shadow:0 4px 10px rgba(0,168,255,0.4); line-height:1;margin-bottom:30px;}
        .widget-date { font-size:15px; font-weight:500; color:rgba(255,255,255,0.95); margin-top:6px; letter-spacing:1px; text-align: center;}
        
        .home-grid { width: 100%; padding: 0 22px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px 10px; }
        .app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .app-item:active { transform: scale(0.85); box-shadow: none;}
        .ico-box { width: 62px; height: 62px; border-radius: 17px; background-size: cover !important; font-size: 28px; background-position: center !important; display: flex; justify-content: center; align-items: center; color: #fff; box-shadow: 0 6px 14px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08); margin-bottom: 7px; overflow: hidden; }
        .app-n { font-size: 11px; text-shadow:0 1px 2px rgba(88,88,88,0.2); font-weight: 500; color:#50657b; }
        #icon_wb  { background: linear-gradient(135deg, #1fa2ff 0%, #12d8fa 100%); }
        #icon_qq  { background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%); }      
        #icon_set { background: linear-gradient(135deg, #e3e6e8 0%, #d3d3d5 100%); color:#7f8c8d; } 
        #icon_psn { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); }
        .page-dots { position:absolute; bottom:20px; display:flex; gap:6px; } .pd{ width:6px; height:6px; background:#fff; opacity:0.5; border-radius:50%; } .pd.crt{ opacity:1; }

        /* Level 2 APP Window */
        .app-window-layer { position: absolute; top:0; left:0; width:100%; height:100%; background: #f4f6f9; z-index: 50; display: flex; flex-direction: column; transform: translateY(110%); border-radius: 46px; transition:transform 0.4s cubic-bezier(0.86, 0, 0.07, 1); }
        .app-window-layer.visible { transform: translateY(0); border-radius:0; max-height: 100vh;}
        .app-nav { padding: 50px 20px 10px 20px ; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.7); backdrop-filter: saturate(180%) blur(20px) !important; border-bottom: 1px solid rgba(0,0,0,0.05); height: 95px; } .nav-title { font-size:24px; font-weight: 700; color: #333; } .btn-nav-back { border:none; background:#eee; padding: 6px 14px; border-radius:15px; font-size:12px; font-weight:600; color:#555; }
        
        .settings-container, .settings-i-scroll { flex:1; padding: 20px; overflow-y: auto; display: flex; flex:1;  flex-direction: column; gap: 20px; padding-bottom: 60px; /* space */ scroll-behavior: smooth;}
        .st-card { background: #fff; padding: 15px; border-radius: 18px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); margin-bottom: 5px;}
        .st-title-label { font-size:11px; margin-bottom:10px; color:#95a5a6; font-weight:700; text-transform:uppercase;} .list-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom:1px dashed #eee; font-size:14px; font-weight:500;} .list-row:last-child { border: none; }
        .lbl-info { color: #5d6d7e; font-size: 13px; } .row-sub { font-size:10px; color:#b2bec3; display:block; margin-top:2px; max-width:180px; overflow:hidden;}
        input.in-field, select.in-field { border: 1px solid #dfe6e9; background:#fff; border-radius: 8px; padding:6px 10px; font-size:12; -webkit-appearance: none; outline:none; transition:.2s;}
        input.in-field:focus { border-color: #74b9ff;box-shadow: 0 0 0 3px rgba(116, 185, 255, 0.1); }
        .btn-action { background: #74b9ff; color:#fff; border:none; border-radius:8px; padding:6px 12px; font-size:12px; display: inline-flex; align-items:center;  transition: .1s; } .btn-action:active { transform:scale(0.95); opacity:0.9; }
        .btn-secondary { background: #dfe6e9; color:#636e72; } .btn-save{ background: #00cace;} .btn-green{background:#00b894;} .btn-danger{background:#ff7675;}
        
        /* Dark Mode CSS */
        .dt-dark .layer-desktop { background: linear-gradient(135deg, #2c3e50, #4ca1af) !important; filter:none !important;} .dt-dark .home-grid .app-n, .dt-dark { color:#eee !important;} 
        .dt-dark .layer-lock { background: #2f3542 !important; } .dt-dark .app-window-layer, .dt-dark .settings-container { background: #121212; }
        .dt-dark .app-nav { background: rgba(20,20,30,0.9); } .dt-dark .st-card { background: #16a085; background: #2d3436; box-shadow:none;} 
        .dt-dark .nav-title, .dt-dark .app-item .app-n {color:#fff !important;} .dt-dark .btn-nav-back {background:#444; color:#fff}
        
        .toggle-switch-lab { position:relative; width:44px; height:24px; } .my-slider-t { position:absolute; inset:0; background:#dcdde1; border-radius:24px; transition:.4s; } input:checked + .my-slider-t { background:#74b9ff; } .my-slider-t:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.3s; } input:checked + .my-slider-t:before { transform: translateX(20px); }

        /* Lock CSS */
        .layer-lock { position: absolute; absolute:0; inset:0; padding-top: 80px; z-index: 100; background: linear-gradient(0deg, #a1c4fd 0%, #c2e9fb 100%); transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; align-items: center; } .layer-lock.open { transform: translateY(-110%) scale(1.1); pointer-events:none; opacity:1;} 
        .slider-bar-lock { position: absolute; bottom: 50px; width: 260px; height: 66px; border: 2px solid rgba(255,255,255,0.8); border-radius: 40px; background: rgba(255,255,255,0.25); display:flex; align-items:center; backdrop-filter: blur(10px); }
        .slide-hint { position: absolute; width:100%; text-align:center; color:#fff; font-size:14; letter-spacing:2px; font-weight:600;} .main-slider { width:100% ;height:100%; -webkit-appearance:none; background:transparent; z-index:5; opacity:0;}
        .real-handle { pointer-events:none; width:58px; height:58px; background:#fff; border-radius:50%; margin:2px; box-shadow:0 5px 10px rgba(0,0,0,0.1); position:absolute; left:0; top:0; transition:0.1s; display:flex;}

        /* ==================== QQ APP CSS ==================== */
        :root {
            --qq-nav-bg: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --qq-nav-text: #555;
            --chat-bg: #fffcf5;
            --bubble-me: #FF9A9E;
            --bubble-me-text: #fff;
            --bubble-other: #fff;
            --bubble-other-text: #555;
            --footer-bg: #fff;
            --avt-radius: 20px;
        }
        
        /* SVG Icon Base Style */
        .svg-icon { width: 1em; height: 1em; fill: currentColor; display: inline-block; vertical-align: middle; }
        .ico-box .svg-icon { width: 32px; height: 32px; }
        .qq-tab-icon .svg-icon { width: 24px; height: 24px; }
        .qq-btn-icon .svg-icon { width: 20px; height: 20px; }

        .qq-app-layer { background: var(--chat-bg); }
        .dt-dark .qq-app-layer { background: #121212; }
        
        .qq-nav-bar { height: 80px; padding-top: 30px; background: var(--qq-nav-bg); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px; color: var(--qq-nav-text); box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 10; transition: background 0.3s; }
        .qq-nav-bar.transparent { background: transparent !important; box-shadow: none; }
        .dt-dark .qq-nav-bar { background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%); }
        .dt-dark .qq-nav-bar.transparent { background: transparent !important; }
        
        .qq-title { font-size: 17px; font-weight: 600; letter-spacing: 0.5px; }
        .qq-btn-icon { font-size: 20px; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: .2s; }
        .qq-btn-icon:active { background: rgba(255,255,255,0.2); }

        .qq-content-area { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .tab-view { flex: 1; overflow-y: auto; padding-bottom: 60px; display: none; flex-direction: column; }
        .tab-view.active { display: flex; animation: fadeIn 0.2s; }

        /* Msg List */
        .qq-search-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .dt-dark .qq-search-bar { background: #1e1e1e; border-bottom-color: #333; }
        .qq-search-bar input { width: 100%; background: #f5f5f5; border: none; border-radius: 6px; padding: 8px; font-size: 13px; text-align: center; color: #333; }
        .dt-dark .qq-search-bar input { background: #333; color: #eee; }

        .chat-item { display: flex; padding: 12px 15px; background: #fff; border-bottom: 1px solid #f0f0f0; align-items: center; cursor: pointer; transition: .2s; }
        .dt-dark .chat-item { background: #1e1e1e; border-bottom-color: #333; }
        .chat-item:active { background: #f5f5f5; }
        .dt-dark .chat-item:active { background: #252525; }
        
        .chat-avatar { width: 48px; height: 48px; border-radius: var(--avt-radius); background: #ddd; margin-right: 12px; flex-shrink: 0; object-fit: cover; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-size: 16px; color: #000; font-weight: 500; }
        .dt-dark .chat-name { color: #fff; }
        .chat-time { font-size: 12px; color: #b2b2b2; }
        .chat-msg-preview { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-badge { min-width: 18px; height: 18px; background: #ff3b30; color: #fff; border-radius: 9px; font-size: 10px; display: flex; align-items: center; justify-content: center; padding: 0 5px; margin-left: 5px; }

        /* Contact List */
        .contact-menu-row { padding: 12px 15px; background: #fff; border-bottom: 1px solid #f0f0f0; font-size: 15px; font-weight: 500; display: flex; align-items: center; cursor: pointer; }
        .dt-dark .contact-menu-row { background: #1e1e1e; border-bottom-color: #333; color: #fff; }
        .contact-group-header { padding: 8px 15px; background: #f9f9f9; color: #888; font-size: 12px; font-weight: 600; display: flex; align-items: center; cursor: pointer; }
        .dt-dark .contact-group-header { background: #252525; color: #aaa; }
        .contact-group-header::before { content: '▼'; font-size: 10px; margin-right: 6px; display: inline-block; transition: .2s; }
        .contact-group-header.collapsed::before { transform: rotate(-90deg); }
        .contact-group-list { display: block; }
        .contact-group-list.collapsed { display: none; }
        
        /* Qzone (Moment) Style */
        .qzone-cover-header { position: relative; height: 260px; background: #888; background-size: cover; background-position: center; margin-bottom: 10px; cursor: pointer; }
        .qzone-cover-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4)); pointer-events: none; }
        .qzone-user-entry { position: absolute; bottom: 20px; right: 20px; display: flex; align-items: center; gap: 10px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); z-index: 20; }
        .qzone-nick { font-size: 16px; font-weight: 700; cursor: pointer; }
        .qzone-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #fff; background: #eee; object-fit: cover; cursor: pointer; }
        
        .moment-item { padding: 15px; background: #fff; border-bottom: 1px solid #f0f0f0; display: flex; gap: 10px; margin-bottom: 10px; }
        .dt-dark .moment-item { background: #1e1e1e; border-bottom-color: #333; }
        .m-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ccc; object-fit: cover; flex-shrink: 0; }
        .m-content { flex: 1; }
        .m-name { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .dt-dark .m-name { color: #fff; }
        .m-time-row { font-size: 12px; color: #999; margin-bottom: 8px; }
        .m-text { font-size: 15px; color: #333; line-height: 1.5; margin-bottom: 8px; }
        .dt-dark .m-text { color: #ddd; }
        .m-imgs { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        .m-img { width: 90px; height: 90px; object-fit: cover; background: #eee; border-radius: 4px; }
        .m-actions { display: flex; justify-content: flex-end; gap: 20px; color: #666; font-size: 13px; margin-top: 10px; }
        
        .m-likes-comments { background: #f7f7f7; margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 13px; }
        .dt-dark .m-likes-comments { background: #222; }
        .m-like-row { color: #576b95; margin-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px;}
        .m-like-row::before { content: '♡ '; }
        .m-comment-row { margin-bottom: 2px; }
        .m-c-name { color: #576b95; font-weight: 500;}
        .m-c-txt { color: #555; } .dt-dark .m-c-txt { color: #aaa; }

        /* Tab Bar */
        .qq-tab-bar { height: 54px; background: #fff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; position: absolute; bottom: 0; width: 100%; padding-bottom: 10px; z-index: 20; }
        .dt-dark .qq-tab-bar { background: #1e1e1e; border-top-color: #333; }
        .qq-tab-item { display: flex; flex-direction: column; align-items: center; color: #999; font-size: 10px; gap: 3px; cursor: pointer; }
        .qq-tab-item.active { color: #1296db; }
        .qq-tab-icon { font-size: 22px; }

        /* Chat Detail Window */
        .chat-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f2; z-index: 60; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .dt-dark .chat-window { background: #121212; }
        .chat-window.visible { transform: translateX(0); }
        
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg-row { display: flex; gap: 10px; max-width: 85%; }
        .msg-row.me { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 36px; height: 36px; border-radius: var(--avt-radius); background: #ccc; flex-shrink: 0; object-fit: cover; }
        .msg-content-box { display: flex; flex-direction: column; gap: 2px; }
        .msg-name { font-size: 10px; color: #999; margin-left: 5px; }
        .msg-row.me .msg-name { text-align: right; margin-right: 5px; }
        
        .msg-bubble { padding: 10px 14px; background: var(--bubble-other); background-size: cover; border-radius: 10px; font-size: 15px; line-height: 1.4; color: var(--bubble-other-text); position: relative; word-break: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: .2s; }
        .dt-dark .msg-bubble { background: #2c3e50; color: #eee; }
        .msg-row.me .msg-bubble { background: var(--bubble-me); background-size: cover; color: var(--bubble-me-text); border-radius: 10px 0 10px 10px; }
        .msg-row:not(.me) .msg-bubble { border-radius: 0 10px 10px 10px; }
        
        /* Image/JSON Spoiler Box */
        .img-spoiler-box { position: relative; width: 100px; height: 100px; border-radius: 10px; overflow: hidden; cursor: pointer; display: inline-block; vertical-align: bottom; background: #eee; }
        .chat-img-bubble { width: 100%; height: 100%; object-fit: cover; }
        .chat-json-text { width: 100%; height: 100%; padding: 5px; font-size: 10px; overflow-y: auto; word-break: break-all; color: #333; background: #fff; }
        .dt-dark .chat-json-text { background: #333; color: #eee; }
        
        .img-spoiler-box.blur::after { content: "点击查看"; position: absolute; inset: 0; background: rgba(255,255,255,0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #333; font-weight: bold; transition: .3s; z-index: 2; }
        .dt-dark .img-spoiler-box.blur::after { background: rgba(0,0,0,0.4); color: #fff; }
        .img-spoiler-box.revealed::after { opacity: 0; pointer-events: none; }
        .img-spoiler-box.revealed { overflow-y: auto; }

        /* Context Menu */
        .msg-context-menu { position: absolute; background: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px; padding: 5px; display: none; z-index: 1000; flex-direction: row; gap: 5px; color: #fff; font-size: 13px; white-space: nowrap; transform: translate(-50%, -100%); margin-top: -10px; }
        .msg-context-menu::after { content:''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        .msg-context-menu.visible { display: flex; animation: fadeIn 0.2s; }
        .msg-menu-item { padding: 8px 12px; cursor: pointer; border-right: 1px solid #555; }
        .msg-menu-item:last-child { border-right: none; }
        .msg-menu-item:active { background: #444; border-radius: 4px; }
        
        /* Voice Bubble */
        .msg-bubble.voice { display: flex; align-items: center; gap: 8px; min-width: 80px; cursor: pointer; }
        .voice-icon { width: 16px; height: 16px; fill: currentColor; }
        .voice-duration { font-size: 12px; opacity: 0.8; }
        .voice-converted-text { font-size: 13px; color: #555; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 6px; margin-top: 5px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dt-dark .voice-converted-text { background: #333; color: #ccc; }

        /* Context Menu */
        .msg-context-menu { position: absolute; background: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px; padding: 5px; display: none; z-index: 1000; flex-direction: row; gap: 5px; color: #fff; font-size: 13px; white-space: nowrap; transform: translate(-50%, -100%); margin-top: -10px; }
        .msg-context-menu::after { content:''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        .msg-context-menu.visible { display: flex; animation: fadeIn 0.2s; }
        .msg-menu-item { padding: 8px 12px; cursor: pointer; border-right: 1px solid #555; }
        .msg-menu-item:last-child { border-right: none; }
        .msg-menu-item:active { background: #444; border-radius: 4px; }
        
        /* Voice Bubble */
        .msg-bubble.voice { display: flex; align-items: center; gap: 8px; min-width: 80px; cursor: pointer; }
        .voice-icon { width: 16px; height: 16px; fill: currentColor; }
        .voice-duration { font-size: 12px; opacity: 0.8; }
        .voice-converted-text { font-size: 13px; color: #555; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 6px; margin-top: 5px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dt-dark .voice-converted-text { background: #333; color: #ccc; }

        .chat-footer { background: var(--footer-bg); background-size: cover; border-top: 1px solid #dcdcdc; padding: 8px 10px; display: flex; align-items: flex-end; gap: 8px; min-height: 50px; padding-bottom: 20px; }
        .dt-dark .chat-footer { background: #1e1e1e; border-top-color: #333; }
        .chat-input { flex: 1; background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-size: 15px; max-height: 100px; overflow-y: auto; outline: none; resize: none; }
        .dt-dark .chat-input { background: #333; border-color: #444; color: #fff; }
        
        .chat-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: transparent; color: #666; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: .2s; cursor: pointer; }
        .dt-dark .chat-btn { color: #aaa; }
        .chat-btn:active { background: #e0e0e0; }
        .btn-send { background: #0099ff; color: #fff; font-size: 14px; width: auto; padding: 0 12px; border-radius: 4px; height: 36px; font-weight: 500; border: none; cursor: pointer; }
        .btn-ai-wait { color: #8e44ad; font-size: 20px; border: 1px solid #8e44ad; } 
        .dt-dark .btn-ai-wait { color: #a55eea; border-color: #a55eea; }
        .btn-ai-wait.loading { animation: spin 1s linear infinite; opacity: 0.6; pointer-events: none; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Chat Setting Page (Independent) */
        .chat-setting-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f2; z-index: 70; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s; }
        .dt-dark .chat-setting-page { background: #000; }
        .chat-setting-page.visible { transform: translateX(0); }
        .cs-scroll { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .cs-group { margin-top: 15px; background: #fff; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; }
        .dt-dark .cs-group { background: #1e1e1e; border-color: #333; }
        .cs-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 15px; color: #000; }
        .dt-dark .cs-row { border-bottom-color: #333; color: #fff; }
        .cs-row:last-child { border-bottom: none; }
        .cs-row-arrow { color: #ccc; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .cs-avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; background: #fff; }
        .dt-dark .cs-avatar-grid { background: #1e1e1e; }
        .cs-member { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .cs-m-img { width: 44px; height: 44px; border-radius: 4px; background: #ddd; object-fit: cover; }
        .cs-m-name { font-size: 10px; color: #888; width: 44px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Contact Modal (Create Chat) */
        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px); }
        .modal-overlay.visible { display: flex; animation: fadeIn 0.2s; }
        .modal-panel { width: 100%; height: 85%; background: #fff; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .dt-dark .modal-panel { background: #1e1e1e; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #333; }
        .dt-dark .modal-header { border-bottom-color: #333; color: #fff; }
        
        .modal-list { flex: 1; overflow-y: auto; padding: 15px; }
        .contact-section { margin-bottom: 20px; }
        .section-title { font-size: 12px; color: #999; margin-bottom: 10px; font-weight: 600; }
        .contact-card { display: flex; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; transition: .2s; cursor: pointer; }
        .dt-dark .contact-card { border-color: #333; }
        .contact-card.selected { background: #e6f7ff; border-color: #1890ff; }
        .dt-dark .contact-card.selected { background: #003a8c; border-color: #1890ff; }
        
        .contact-card img { width: 40px; height: 40px; border-radius: 8px; margin-right: 10px; background: #eee; object-fit: cover;}
        .contact-name { font-size: 14px; font-weight: 500; color: #333; }
        .dt-dark .contact-name { color: #eee; }
        .check-circle { margin-left: auto; width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
        .contact-card.selected .check-circle { background: #1890ff; border-color: #1890ff; }
        .check-circle::after { content: "✓"; color: #fff; font-size: 12px; display: none; }
        .contact-card.selected .check-circle::after { display: block; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ==================== PERSONA APP CSS ==================== */
        .psn-tabs { padding: 10px 20px; display: flex; gap: 15px; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .dt-dark .psn-tabs { background: #1e1e1e; border-bottom-color: #333; }
        .psn-tab { padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #888; background: #f5f5f5; cursor: pointer; transition: .2s; }
        .dt-dark .psn-tab { background: #252525; color: #aaa; }
        .psn-tab.active { background: #FF9A9E; color: #fff; box-shadow: 0 4px 10px rgba(255, 154, 158, 0.3); }
        .psn-tab.active-u { background: #a29bfe; color: #fff; box-shadow: 0 4px 10px rgba(162, 155, 254, 0.3); }

        .psn-list { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-content: flex-start; }
        .psn-card { background: #fff; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; overflow: hidden; }
        .dt-dark .psn-card { background: #2d3436; }
        .psn-card-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .psn-card-name { font-size: 14px; font-weight: 600; color: #333; }
        .dt-dark .psn-card-name { color: #eee; }
        .psn-card-desc { font-size: 10px; color: #999; text-align: center; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .fab-add { position: absolute; bottom: 30px; right: 30px; width: 56px; height: 56px; background: #FF9A9E; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 28px; box-shadow: 0 6px 16px rgba(255, 154, 158, 0.4); cursor: pointer; transition: .2s; z-index: 10; }
        .fab-add:active { transform: scale(0.9); }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 600; }
        .dt-dark .form-label { color: #aaa; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; outline: none; transition: .2s; }
        .dt-dark .form-input { background: #333; border-color: #444; color: #fff; }
        .form-input:focus { border-color: #FF9A9E; }
        textarea.form-input { resize: none; height: 80px; }
        
        .avatar-uploader { width: 80px; height: 80px; border-radius: 50%; background: #f0f0f0; border: 2px dashed #ccc; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .avatar-uploader img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-uploader::after { content: "+"; font-size: 24px; color: #ccc; }
        .avatar-uploader.has-img::after { display: none; }
        .avatar-uploader.has-img img { display: block; }

        /* ==================== WORLDBOOK APP CSS ==================== */
        .wb-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .wb-card { background: #fff; border-radius: 12px; padding: 15px; border: 2px solid transparent; transition: .2s; cursor: pointer; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .dt-dark .wb-card { background: #2d3436; }
        .wb-card.active { border-color: #00cace; background: #e0fbfd; }
        .dt-dark .wb-card.active { background: #003a3e; border-color: #00cace; }

        .wb-header { display: flex; justify-content: space-between; align-items: center; }
        .wb-title { font-weight: 700; font-size: 15px; color: #333; }
        .dt-dark .wb-title { color: #fff; }
        .wb-status { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #eee; color: #999; transition: .2s; }
        .wb-card.active .wb-status { background: #00cace; color: #fff; }

        .wb-content { font-size: 12px; color: #666; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }
        .dt-dark .wb-content { color: #aaa; }
        
        .fab-wb { background: #00cace; box-shadow: 0 6px 16px rgba(0, 202, 206, 0.4); }

        /* Moment Publish Modal */
        .modal-input-area { width: 100%; height: 120px; border: none; outline: none; font-size: 15px; resize: none; margin-bottom: 10px; background: transparent; }
        .dt-dark .modal-input-area { color: #fff; }

        /* Emoji Panel */
        .emoji-panel { height: 0; overflow: hidden; background: #f2f2f2; transition: height 0.3s; display: flex; flex-direction: column; }
        .dt-dark .emoji-panel { background: #1e1e1e; }
        .emoji-panel.open { height: 200px; border-top: 1px solid #ddd; }
        .dt-dark .emoji-panel.open { border-top-color: #333; }
        
        .emoji-toolbar { padding: 5px 10px; display: flex; gap: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .emoji-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-content: flex-start; }
        .emoji-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; background: #fff; border: 1px solid transparent; }
        .emoji-item:active { transform: scale(0.9); }
        .emoji-add-btn { width: 100%; aspect-ratio: 1; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #999; cursor: pointer; }

        /* Weibo App CSS */
        #icon_weibo { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #f6d365 100%); background: #e6162d; color:#fff; }
        .wb-feed { flex: 1; overflow-y: auto; background: #f2f2f2; }
        .dt-dark .wb-feed { background: #000; }
        
        .wb-post { background: #fff; margin-bottom: 10px; padding: 15px; display: flex; flex-direction: column; gap: 10px; cursor: pointer; }
        .dt-dark .wb-post { background: #1e1e1e; }
        .wb-post-header { display: flex; align-items: center; gap: 10px; }
        .wb-p-avt { width: 40px; height: 40px; border-radius: 50%; background: #eee; object-fit: cover; }
        .wb-p-info { display: flex; flex-direction: column; }
        .wb-p-name { font-size: 14px; font-weight: 700; color: #333; }
        .dt-dark .wb-p-name { color: #f69626; }
        .wb-p-time { font-size: 11px; color: #999; }
        .wb-p-content { font-size: 15px; line-height: 1.5; color: #333; }
        .dt-dark .wb-p-content { color: #eee; }
        .wb-p-footer { border-top: 1px solid #f2f2f2; padding-top: 10px; display: flex; justify-content: space-around; color: #999; font-size: 13px; }
        .dt-dark .wb-p-footer { border-top-color: #333; }
        
        /* Weibo Detail */
        .wb-detail-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 80; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .dt-dark .wb-detail-layer { background: #121212; }
        .wb-detail-layer.visible { transform: translateX(0); }
        .wb-comment-list { flex: 1; overflow-y: auto; background: #fff; padding-bottom: 20px; }
        .dt-dark .wb-comment-list { background: #121212; }
        .wb-comment-sec-title { padding: 10px 15px; font-size: 13px; font-weight: 700; border-bottom: 1px solid #eee; background: #fff; }
        .dt-dark .wb-comment-sec-title { background: #1e1e1e; border-bottom-color: #333; color: #eee; }
        
        .wb-cmt-item { display: flex; gap: 10px; padding: 10px 15px; border-bottom: 1px solid #f8f8f8; }
        .dt-dark .wb-cmt-item { border-bottom-color: #222; }
        .wb-cmt-avt { width: 32px; height: 32px; border-radius: 50%; background: #eee; object-fit: cover; }
        .wb-cmt-box { flex: 1; }
        .wb-cmt-name { font-size: 12px; color: #eb7350; font-weight: 600; margin-bottom: 2px; }
        .wb-cmt-txt { font-size: 14px; color: #333; line-height: 1.4; }
        .dt-dark .wb-cmt-txt { color: #ccc; }

        /* Weibo Hot Search */
        .wb-nav-tabs { display:flex; gap:20px; font-size:16px; font-weight:700; color:#999; }
        .wb-nav-tab.active { color:#333; position:relative; }
        .dt-dark .wb-nav-tab.active { color:#fff; }
        .wb-nav-tab.active::after { content:""; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); width:20px; height:3px; background:#f69626; border-radius:2px; }
        
        .wb-hot-list { flex:1; overflow-y:auto; background:#fff; }
        .dt-dark .wb-hot-list { background:#000; }
        .wb-hot-item { display:flex; align-items:center; padding:12px 15px; border-bottom:1px solid #f8f8f8; cursor:pointer; }
        .dt-dark .wb-hot-item { border-bottom-color:#222; }
        .wb-rank { width:24px; font-size:16px; font-weight:700; color:#999; font-style:italic; margin-right:10px; text-align:center; }
        .wb-rank.top-1 { color:#ff4757; } .wb-rank.top-2 { color:#ff6b81; } .wb-rank.top-3 { color:#ffa502; }
        .wb-topic { flex:1; font-size:15px; color:#333; font-weight:500; }
        .dt-dark .wb-topic { color:#eee; }
        .wb-heat { font-size:11px; color:#999; margin-left:10px; }
        .wb-tag { font-size:10px; color:#fff; padding:1px 3px; border-radius:3px; margin-left:5px; font-weight:400; }
        .wb-tag.hot { background:#ff9f43; } .wb-tag.new { background:#ff6b6b; } .wb-tag.bao { background:#b33939; } .wb-tag.rec { background:#70a1ff; }

        /* Weibo Profile */
        .wb-prof-header { position:relative; height:180px; background: #333; background-size:cover; background-position:center; }
        .wb-prof-avt { position:absolute; bottom:-30px; left:20px; width:80px; height:80px; border-radius:50%; border:3px solid #fff; background:#eee; object-fit:cover; z-index:2; }
        .wb-prof-info { padding: 40px 20px 10px 20px; background:#fff; margin-bottom:10px; }
        .dt-dark .wb-prof-info { background:#1e1e1e; }
        .wb-prof-nick { font-size:20px; font-weight:bold; color:#333; }
        .dt-dark .wb-prof-nick { color:#fff; }
        .wb-prof-bio { font-size:12px; color:#999; margin-top:5px; }
        .wb-prof-stats { display:flex; gap:20px; margin-top:15px; font-size:14px; color:#333; font-weight:600; }
        .dt-dark .wb-prof-stats { color:#ccc; }
        .wb-prof-stats span { font-weight:400; color:#999; font-size:12px; }

        /* Weibo Topic */
        .wb-topic-header { padding:30px 20px; background:linear-gradient(135deg, #f6d365 0%, #fda085 100%); color:#fff; }
        .wb-topic-title { font-size:20px; font-weight:bold; }
        .wb-topic-read { font-size:12px; opacity:0.8; margin-top:5px; }
        
        .wb-pub-img-btn { width:60px; height:60px; background:#f0f0f0; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#999; font-size:12px; cursor:pointer; }
        .wb-p-img { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 5px; object-fit: cover; }

        /* Chat Tools Panel */
        .chat-tools-panel { height: 0; overflow: hidden; background: #f2f2f2; transition: height 0.3s; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 20px; align-content: start; }
        .dt-dark .chat-tools-panel { background: #1e1e1e; }
        .chat-tools-panel.open { height: 200px; border-top: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        .dt-dark .chat-tools-panel.open { border-top-color: #333; }
        
        .tool-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .tool-icon-box { width: 50px; height: 50px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #555; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dt-dark .tool-icon-box { background: #333; color: #aaa; }
        .tool-name { font-size: 11px; color: #666; }
        .dt-dark .tool-name { color: #aaa; }

        /* Generic Tool Layer */
        .tool-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 100; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .dt-dark .tool-layer { background: #000; }
        .tool-layer.visible { transform: translateY(0); }
        .tool-content { flex: 1; overflow-y: auto; padding: 15px; }
        .tool-list-item { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .dt-dark .tool-list-item { background: #1e1e1e; color: #eee; }
        
        /* Listen Together UI - NetEase Style */
        .music-player-ui { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; color: #fff; background: #111; }
        .music-bg-blur { position: absolute; inset: 0; background-size: cover; background-position: center; filter: blur(30px) brightness(0.5); transform: scale(1.2); z-index: 0; transition: background-image 0.5s; }
        
        .music-top-bar { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; margin-top: 30px; }
        .music-top-title { font-size: 16px; font-weight: 500; }
        
        .music-content { position: relative; z-index: 10; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 20px; }
        
        /* Avatars */
        .music-avatars-box { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 30px; position: relative; }
        .music-avatars-box::after { content: ''; position: absolute; width: 80px; height: 1px; background: rgba(255,255,255,0.2); z-index: -1; }
        .m-avt-halo { width: 44px; height: 44px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.6); object-fit: cover; box-shadow: 0 0 15px rgba(255,255,255,0.1); background: #333; }
        
        /* Disc */
        .music-disc-container { width: 260px; height: 260px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; position: relative; }
        .music-disc { width: 240px; height: 240px; border-radius: 50%; background: #111; display: flex; align-items: center; justify-content: center; border: 6px solid rgba(20,20,20,0.8); animation: rotate 20s linear infinite; animation-play-state: paused; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .music-disc.playing { animation-play-state: running; }
        .music-cover { width: 160px; height: 160px; border-radius: 50%; object-fit: cover; }
        
        /* Info & Controls */
        .music-info-area { width: 100%; padding: 20px 25px; position: relative; z-index: 10; display: flex; flex-direction: column; }
        .music-song-info { margin-bottom: 20px; display: flex; flex-direction: column; gap: 5px; }
        .music-song-title { font-size: 22px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .music-song-artist { font-size: 14px; color: rgba(255,255,255,0.6); }
        
        .music-ctrl-area { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; margin-bottom: 20px; }
        .btn-m-ctrl { background: transparent; border: none; color: #fff; font-size: 26px; cursor: pointer; opacity: 0.9; transition: .2s; }
        .btn-m-ctrl:active { transform: scale(0.9); }
        .btn-m-play { font-size: 40px; width: 64px; height: 64px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; }
        
        /* Playlist Drawer */
        .music-playlist-drawer { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background: rgba(30,30,30,0.95); border-radius: 20px 20px 0 0; z-index: 50; transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; backdrop-filter: blur(20px); }
        .music-playlist-drawer.visible { transform: translateY(0); }
        .mp-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .mp-title { font-size: 16px; font-weight: 700; color: #fff; }
        .mp-title span { font-size: 12px; font-weight: 400; color: #888; margin-left: 5px; }
        
        .mp-actions { display: flex; gap: 10px; padding: 15px 20px; }
        .btn-mp-act { flex: 1; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: #fff; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: .2s; }
        .btn-mp-act:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }
        
        .mp-list { flex: 1; overflow-y: auto; padding: 0 20px; }
        .mp-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .mp-idx { width: 30px; font-size: 14px; color: #666; text-align: center; }
        .mp-info { flex: 1; overflow: hidden; }
        .mp-s-name { font-size: 15px; margin-bottom: 4px; color: #fff; }
        .mp-s-art { font-size: 12px; color: #888; }
        .mp-item.active .mp-s-name, .mp-item.active .mp-idx { color: #ff4757; }
        .mp-del { color: #666; padding: 5px; }
        
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Context Menu */
        .msg-context-menu { position: absolute; background: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px; padding: 5px; display: none; z-index: 1000; flex-direction: row; gap: 5px; color: #fff; font-size: 13px; white-space: nowrap; transform: translate(-50%, -100%); margin-top: -10px; }
        .msg-context-menu::after { content:''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        .msg-context-menu.visible { display: flex; animation: fadeIn 0.2s; }
        .msg-menu-item { padding: 8px 12px; cursor: pointer; border-right: 1px solid #555; }
        .msg-menu-item:last-child { border-right: none; }
        .msg-menu-item:active { background: #444; border-radius: 4px; }
        
        /* Voice Bubble */
        .msg-bubble.voice { display: flex; align-items: center; gap: 8px; min-width: 80px; cursor: pointer; }
        .voice-icon { width: 16px; height: 16px; fill: currentColor; }
        .voice-duration { font-size: 12px; opacity: 0.8; }
        .voice-converted-text { font-size: 13px; color: #555; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 6px; margin-top: 5px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dt-dark .voice-converted-text { background: #333; color: #ccc; }

        /* Context Menu */
        .msg-context-menu { position: absolute; background: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px; padding: 5px; display: none; z-index: 1000; flex-direction: row; gap: 5px; color: #fff; font-size: 13px; white-space: nowrap; transform: translate(-50%, -100%); margin-top: -10px; }
        .msg-context-menu::after { content:''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        .msg-context-menu.visible { display: flex; animation: fadeIn 0.2s; }
        .msg-menu-item { padding: 8px 12px; cursor: pointer; border-right: 1px solid #555; }
        .msg-menu-item:last-child { border-right: none; }
        .msg-menu-item:active { background: #444; border-radius: 4px; }
        
        /* Voice Bubble */
        .msg-bubble.voice { display: flex; align-items: center; gap: 8px; min-width: 80px; cursor: pointer; }
        .voice-icon { width: 16px; height: 16px; fill: currentColor; }
        .voice-duration { font-size: 12px; opacity: 0.8; }
        .voice-converted-text { font-size: 13px; color: #555; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 6px; margin-top: 5px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dt-dark .voice-converted-text { background: #333; color: #ccc; }

        /* === Call UI (Voice & Video) === */
        .call-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
        .call-layer.visible { transform: translateY(0); }
        
        /* Video Backgrounds */
        .call-bg-video { position: absolute; inset: 0; background-size: cover; background-position: center; z-index: 0; }
        .call-bg-video::after { content:''; position: absolute; inset:0; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); transition: .3s; }
        .call-layer.video-mode .call-bg-video::after { backdrop-filter: none; background: rgba(0,0,0,0.1); } /* Video mode clear */
        
        /* Mini Window (Me) in Video Mode */
        .call-mini-window { position: absolute; top: 60px; right: 20px; width: 90px; height: 160px; background: #000; border-radius: 8px; overflow: hidden; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; border: 1px solid rgba(255,255,255,0.2); }
        .call-mini-window img { width: 100%; height: 100%; object-fit: cover; }
        .call-layer.video-mode .call-mini-window { display: block; }

        /* Main Content */
        .call-content { position: relative; z-index: 5; flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 80px; transition: .3s; }
        
        /* Avatar & Info (Voice Mode) */
        .call-user-info { display: flex; flex-direction: column; align-items: center; gap: 15px; transition: .3s; }
        .call-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .call-name { font-size: 24px; color: #fff; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .call-status { font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 5px; }

        /* Video Mode Adjustments */
        .call-layer.video-mode .call-content { padding-top: 40px; justify-content: flex-end; padding-bottom: 120px; }
        .call-layer.video-mode .call-user-info { transform: scale(0.8); opacity: 0; pointer-events: none; position: absolute; top: 50px; } /* Hide standard info in video */
        
        /* Chat Bubbles Overlay (Danmaku style) */
        .call-chat-area { position: absolute; top: 150px; left: 0; width: 100%; bottom: 180px; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; z-index: 6; pointer-events: none; mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); }
        
        .call-bubble-row { display: flex; width: 100%; margin-bottom: 5px; animation: slideUpFade 0.3s ease-out; pointer-events: auto; }
        .call-bubble-row.me { justify-content: flex-end; }
        
        .call-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 15px; line-height: 1.4; color: #fff; position: relative; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .call-bubble-row.other .call-bubble { background: rgba(255,255,255,0.2); border-bottom-left-radius: 2px; border: 1px solid rgba(255,255,255,0.1); }
        .call-bubble-row.me .call-bubble { background: rgba(30, 215, 96, 0.6); border-bottom-right-radius: 2px; border: 1px solid rgba(30, 215, 96, 0.3); }
        
        /* Input Area (Centered) */
        .call-input-box { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 300px; z-index: 20; display: flex; align-items: center; gap: 10px; opacity: 0.9; transition: .3s; }
        .call-input-box:focus-within { opacity: 1; width: 90%; }
        .call-input { flex: 1; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 10px 15px; border-radius: 20px; font-size: 14px; outline: none; backdrop-filter: blur(5px); }
        .call-input::placeholder { color: rgba(255,255,255,0.5); }
        .call-btn-send { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* Controls Footer */
        .call-footer { position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; z-index: 10; display: flex; justify-content: space-around; align-items: center; padding-bottom: 20px; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); }
        .call-ctrl-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; font-size: 24px; cursor: pointer; backdrop-filter: blur(5px); transition: .2s; border: none; }
        .call-ctrl-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }
        .call-ctrl-btn.hangup { background: #ff4757; width: 70px; height: 70px; font-size: 30px; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); }
        .call-ctrl-label { font-size: 10px; margin-top: 5px; opacity: 0.8; }

    </style>
<style>.Po4BvhR1CK2tJaywJ6AN path {
  fill: var(--icon-path-fill);
}
.Oz4yDjua3Qe6thqkZYf_ path {
  transition: 0.2s all;
}
.Oz4yDjua3Qe6thqkZYf_:hover path {
  fill: var(--icon-hover-fill);
}
</style><style>/* ！！！切勿直接改动该文件，该文件由 generator.ts 自动生成！！！ */
/* !!! DONT MODIFY THIS FILE DIRECTLY, THIS FILE IS GENERATED BY generator.ts AUTOMATICALLY !!! */
.ibW4Oa5B7s2zJKKZ4pCg {
  user-select: none;
}
.AtqKyJetjrG4smuk35Np {
  max-width: 346px;
  width: auto;
  height: 36px;
  background-color: var(--quark-style-white-color, #fff);
  padding-left: 10px;
  padding-right: 4px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
  border: 1px solid var(--quark-style-gray-20-color, rgba(6, 10, 38, 0.12));
  box-shadow: 0 12px 32px -6px var(--quark-style-gray-30-fixed-color, rgba(6, 10, 38, 0.24));
  border-radius: 10px;
}
.ibW4Oa5B7s2zJKKZ4pCg .g6iGsZa_KHMeW2yICzQQ {
  height: 28px;
  display: flex;
  align-items: center;
  margin-right: 6px;
}
.ibW4Oa5B7s2zJKKZ4pCg .e4UXx38MPgfHdym_Lzt0 {
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  height: 28px;
  padding: 0 6px;
  margin-right: 2px;
  border-radius: 6px;
  column-gap: 4px;
}
.ibW4Oa5B7s2zJKKZ4pCg .e4UXx38MPgfHdym_Lzt0:hover:not(.ibW4Oa5B7s2zJKKZ4pCg .kNOcXLDT_cCrcoY8LTm8) {
  background: var(--quark-style-gray-10-color, rgba(6, 10, 38, 0.06));
}
.ibW4Oa5B7s2zJKKZ4pCg .kNOcXLDT_cCrcoY8LTm8 {
  cursor: default;
}
.ibW4Oa5B7s2zJKKZ4pCg .kNOcXLDT_cCrcoY8LTm8 .Va3czASiR9Zztyl_lD4M {
  color: var(--quark-style-gray-40-color, rgba(6, 10, 38, 0.4)) !important;
}
.ibW4Oa5B7s2zJKKZ4pCg .e4UXx38MPgfHdym_Lzt0 .Va3czASiR9Zztyl_lD4M {
  font-size: 12px;
  color: var(--quark-style-gray-color, #060A26);
  line-height: 16px;
  white-space: nowrap;
  position: relative;
}
.ibW4Oa5B7s2zJKKZ4pCg .llw0qsmiI_08u93bFdNg {
  position: relative;
  width: 28px;
  height: 28px;
  overflow: visible !important;
}
.ibW4Oa5B7s2zJKKZ4pCg .LEo8kpqIERehkv8AhAfG {
  width: 28px;
  height: 28px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  border-radius: 6px;
  overflow: visible !important;
}
.ibW4Oa5B7s2zJKKZ4pCg .LEo8kpqIERehkv8AhAfG:hover {
  background: var(--quark-style-gray-10-color, rgba(6, 10, 38, 0.06));
}
.ibW4Oa5B7s2zJKKZ4pCg .zoNmooxAnbLEJSN8m1Jg {
  box-sizing: border-box;
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 110px;
  max-height: 136px;
  height: auto;
  top: 36px;
  right: -5px;
  padding: 4px 0;
  background-color: var(--quark-style-white-color, #fff);
  border: 1px solid var(--quark-style-gray-20-color, rgba(6, 10, 38, 0.12));
  box-shadow: 0 4px 16px -6px var(--quark-style-gray-20-fixed-color, rgba(6, 10, 38, 0.12));
  border-radius: 8px;
  overflow: visible !important;
  row-gap: 4px;
}
.ibW4Oa5B7s2zJKKZ4pCg .O1imPofna4elG_8NcQnR {
  top: -77px;
}
.ibW4Oa5B7s2zJKKZ4pCg .mdH0IY7jS3Swn5vdX6tz {
  width: 102px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  cursor: pointer;
  column-gap: 8px;
  border-radius: 6px;
  padding: 0 6px;
  box-sizing: border-box;
}
.ibW4Oa5B7s2zJKKZ4pCg .mdH0IY7jS3Swn5vdX6tz:hover:not(.ibW4Oa5B7s2zJKKZ4pCg .dEdHLVmn_L2GAzb_cmwt) {
  background: var(--quark-style-gray-10-color, rgba(6, 10, 38, 0.06));
}
.ibW4Oa5B7s2zJKKZ4pCg .dEdHLVmn_L2GAzb_cmwt {
  cursor: default;
}
.ibW4Oa5B7s2zJKKZ4pCg .dEdHLVmn_L2GAzb_cmwt .zEraruudgjR2MToGu4Kw {
  color: var(--quark-style-gray-40-color, rgba(6, 10, 38, 0.4)) !important;
}
.ibW4Oa5B7s2zJKKZ4pCg .XfCMwvO0DsqFCeyzPYP2 {
  width: 16px;
  height: 16px;
}
.ibW4Oa5B7s2zJKKZ4pCg .zEraruudgjR2MToGu4Kw {
  font-size: 12px;
  color: var(--quark-style-gray-color, #060A26);
}
.ibW4Oa5B7s2zJKKZ4pCg .KZeoAuXbMIkWzOT4PcH5 {
  width: 100%;
  height: 1px;
  background: var(--quark-style-gray-10-color, rgba(6, 10, 38, 0.06));
}
.ZL32C_XdLL8UQRZ3zObd {
  display: flex;
  align-items: center;
}
.u5llx7cIQZLdrjP5Vag1 {
  width: 28px;
  height: 28px;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 16px;
  cursor: pointer;
  margin-right: 12px;
  background: var(--quark-style-gray-60-color, rgba(6, 10, 38, 0.6));
}
.ZL32C_XdLL8UQRZ3zObd .LEo8kpqIERehkv8AhAfG {
  border-radius: 16px !important;
  background: var(--quark-style-gray-60-color, rgba(6, 10, 38, 0.6)) !important;
}
.ZL32C_XdLL8UQRZ3zObd .zoNmooxAnbLEJSN8m1Jg {
  right: 0 !important;
}
.ZL32C_XdLL8UQRZ3zObd {
  overflow: visible !important;
}
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.2/mammoth.browser.min.js"></script>
</style><style>
/* === 全屏修改开始 === */
body { display: block !important; background: #000 !important; }
.phone-monitor { width: 100% !important; height: 100vh !important; border-radius: 0 !important; box-shadow: none !important; margin: 0 !important; }
.screen-inner { border-radius: 0 !important; }
.layer-desktop.apps-open { transform: none !important; border-radius: 0 !important; filter: none !important; }
/* === 全屏修改结束 === */
</style></head>


<body>
<svg style="display:none;">
<defs>
<symbol id="icon-back" viewBox="0 0 24 24"><path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></symbol>
<symbol id="icon-add" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></symbol>
<symbol id="icon-menu" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></symbol>
<symbol id="icon-msg" viewBox="0 0 24 24"><path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></symbol>
<symbol id="icon-friends" viewBox="0 0 24 24"><path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></symbol>
<symbol id="icon-star" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></symbol>
<symbol id="icon-face" viewBox="0 0 24 24"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path></symbol>
<symbol id="icon-send" viewBox="0 0 24 24"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></symbol>
<symbol id="icon-wb" viewBox="0 0 24 24"><path fill="currentColor" d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"></path></symbol>
<symbol id="icon-qq" viewBox="0 0 24 24"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm4.24 16L12 15.45 7.77 18l1.12-4.81-3.73-3.23 4.92-.42L12 5l1.92 4.53 4.92.42-3.73 3.23L16.23 18z"></path></symbol>
<symbol id="icon-set" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></symbol>
<symbol id="icon-psn" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path></symbol>
<symbol id="icon-weibo" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"></path></symbol>
<symbol id="icon-plus-c" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path></symbol>
<symbol id="icon-tool-phone" viewBox="0 0 24 24"><path fill="currentColor" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"></path></symbol>
<symbol id="icon-tool-cart" viewBox="0 0 24 24"><path fill="currentColor" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"></path></symbol>
<symbol id="icon-tool-map" viewBox="0 0 24 24"><path fill="currentColor" d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"></path></symbol>
<symbol id="icon-tool-music" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path></symbol>
<symbol id="icon-voice" viewBox="0 0 24 24"><path fill="currentColor" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path><path fill="currentColor" d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path></symbol>
<symbol id="icon-call-voice" viewBox="0 0 24 24"><path fill="currentColor" d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.33 8.5 5.14 8.5 3.91 8.5 3.4 8.1 3 7.6 3H3.83c-.5 0-.93.41-.93.91C2.9 13.91 10.09 21.1 20.09 21.1c.5 0 .91-.43.91-.93v-3.79c0-.5-.41-.9-.91-.9z"></path></symbol>
<symbol id="icon-call-video" viewBox="0 0 24 24"><path fill="currentColor" d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"></path></symbol>
</defs>
</svg>
<div class="phone-monitor" id="smartDevice">
     
<div class="screen-inner">
        <!-- 头部状态栏 -->
        <div class="status-top">
             <span id="stTm">13:44</span>
             <div class="status-right">
                 <div class="signal-icon">
                     <div class="signal-bar active" style="height:40%"></div>
                     <div class="signal-bar active" style="height:60%"></div>
                     <div class="signal-bar active" style="height:80%"></div>
                     <div class="signal-bar" style="height:100%"></div>
                 </div>
                 <div class="battery-icon">
                     <div class="battery-level"></div>
                 </div>
             </div>
        </div>

        <!-- :::: Layer 1: Q萌桌面 Container :::: -->
        <div class="layer-desktop" id="sceneDesktop">
             <div class="desktop-content">
                  
                  <div class="widget-clock">
                       <div id="dkClk">13:44</div>
                       <div id="dkDate" class="widget-date">1月3日</div>
                  </div>

                  <!-- 3x4 App Grid -->
                  <div class="home-grid">
                      <!-- WB -->
                      <div class="app-item">
                           <div class="ico-box" id="icon_wb" onclick="appHub.openS(&#39;wb&#39;)">
                               <svg class="svg-icon"><use href="#icon-wb"></use></svg>
                           </div>
                           <div class="app-n">世界书</div>
                      </div>
                      
                      <!-- QQ -->
                      <div class="app-item">
                            <!-- 已配ID icon_qq -->
                            <div class="ico-box" id="icon_qq" onclick="appHub.openS(&#39;qq&#39;)">
                                <svg class="svg-icon"><use href="#icon-qq"></use></svg>
                            </div>
                            <div class="app-n">QQ</div>
                      </div>

                       <!-- SETTINGS (Trigger) -->
                       <div class="app-item">
                           <div class="ico-box" id="icon_set" onclick="appHub.openS(&#39;set&#39;)">
                               <svg class="svg-icon"><use href="#icon-set"></use></svg>
                           </div>
                           <div class="app-n">设置</div>
                      </div>

                       <!-- Persona 人设 -->
                      <div class="app-item">
                          <!-- 已配ID icon_psn -->
                          <div class="ico-box" id="icon_psn" onclick="appHub.openS(&#39;psn&#39;)">
                               <svg class="svg-icon"><use href="#icon-psn"></use></svg>
                          </div>
                          <div class="app-n">人设</div>
                      </div>

                      <!-- Weibo -->
                      <div class="app-item">
                          <div class="ico-box" id="icon_weibo" onclick="appHub.openS(&#39;weibo&#39;)">
                               <svg class="svg-icon" style="font-size:32px"><use href="#icon-weibo"></use></svg>
                          </div>
                          <div class="app-n">微博</div>
                      </div>
                  </div>

                  <!-- Dot -->
                   <div class="page-dots"> <div class="pd crt"></div><div class="pd"></div></div>
             </div>
        </div>

        <!-- :::: Layer 2: Settings App (APP Window) :::: -->
        <div class="app-window-layer" id="winSet" style="display: none;">
             <div class="app-nav">
                  <h1 class="nav-title">系统设置</h1>
                  <button class="btn-nav-back" onclick="appHub.exit()">
                      <svg class="svg-icon"><use href="#icon-back"></use></svg> 返回 Desktop
                  </button>
             </div>

             <div class="settings-container">
                  <!-- CARD 1 DISPLAY 外观篇 -->
                  <div class="st-card">
                       <div class="st-title-label">DISPLAY (外观) </div>
                       
                       <div class="list-row"> <!-- 深色模式 -->
                            <span class="lbl-info">深色模式 / Dark Mode</span>
                            <label class="toggle-switch-lab">   <input type="checkbox" class="toggle-check" id="tg_dark" onchange="runUI.toggleDark(this)"><span class="my-slider-t"></span> </label>
                       </div>
                       <div class="list-row"> <!-- 字体尺寸 -->
                             <span class="lbl-info">全局字体缩放 Scale</span>
                             <input type="range" style="width:100px" min="0.8" max="1.3" step="0.1" value="1" onchange="runUI.changeFtSize(this)">
                       </div>

                       <!-- 字体 URL 更改 -->
                        <div class="list-row" style="flex-wrap:wrap"> <!-- 行内不一定够宽 -->
                           <div class="lbl-info form-wide">🌐 在线 / URL 导入字体 (点 Apply 生效)</div>
                           <div style="width: 100%; display: flex; gap:5px; margin-top:5px;">
                               <input type="text" id="fturl" class="in-field" style="flex:1" placeholder="https://..../font.woff2">
                               <button class="btn-action btn-green" onclick="runUI.setUrlFont()">Apply ✔</button>
                           </div>
                       </div>
                    
                       <!-- WALL -->
                        <div class="list-row">
                            <span class="lbl-info">更换主路壁纸 (Wallpaper)</span>
                            <button class="btn-action btn-secondary" style="position:relative">
                                Select Jpg... <input type="file" onchange="runUI.setWall(event)" accept="image/*" style="cursor:pointer; position:absolute; inset:0;opacity:0;">
                            </button>
                        </div>
                  </div> 


                 <!-- ==============================
                       CARD 2: ICONS (图标自定义区 - 核心升级！)
                        - 已经添加全员上传 !
                  ============================== -->
                  <div class="st-card">
                       <div class="st-title-label">ICONS (应用图标自定义)</div>
                       
                       <!-- Row: WorldBook -->
                       <div class="list-row">
                           <div class="lbl-info">📚 世界书 (WorldBook)</div>
                           <button class="btn-action btn-secondary" style="position:relative">
                               Select IMG <input type="file" onchange="runUI.iconRep(&#39;icon_wb&#39;,event)" style="cursor:pointer; opacity:0; position:absolute; inset:0">
                           </button>
                       </div>

                       <!-- Row: QQ -->
                       <div class="list-row">
                        <div class="lbl-info">🐧 QQ应用 </div>
                        <!-- 这里绑定到了 icon_qq -->
                            <button class="btn-action btn-secondary" style="position:relative">
                                Select IMG <input type="file" onchange="runUI.iconRep(&#39;icon_qq&#39;,event)" style="cursor:pointer; opacity:0; position:absolute; inset:0">
                            </button>
                       </div>

                        <!-- Row: Persona Settings -->
                       <div class="list-row">
                        <div class="lbl-info">💜 人设 (Persona/OC) </div>
                            <!-- 这里绑定到了 icon_psn -->
                            <button class="btn-action btn-secondary" style="position:relative">
                                Select IMG <input type="file" onchange="runUI.iconRep(&#39;icon_psn&#39;,event)" style="cursor:pointer; opacity:0; position:absolute; inset:0">
                            </button>
                        </div>
                   
                       <!-- Row: System Set -->
                       <div class="list-row">
                           <div class="lbl-info">⚙️ 设置 (Settings)</div>
                           <button class="btn-action btn-secondary" style="position:relative">
                               Select IMG <input type="file" onchange="runUI.iconRep(&#39;icon_set&#39;,event)" style="cursor:pointer; opacity:0; position:absolute; inset:0">
                           </button>
                       </div>

                        <div style="font-size:10px; color:#aaa; margin-top:5px; text-align:right;">支持 png/jpg，会自动裁剪圆角填满</div>
                  </div>

                <!-- CARD 3: API Config Hub -->
                <div class="st-card">
                     <div class="st-title-label">CONNECTIVITY (真实API联络站)</div>
                     <div class="api-custom-box">
                          
                          <!-- Config Switcher -->
                          <div class="list-row" style="border-bottom:1px dashed #eee; padding-bottom:10px; margin-bottom:10px;">
                               <span class="lbl-info">切换配置</span>
                               <select class="in-field" id="cfg_list" style="flex:1; margin-left:10px;" onchange="apis.switchCfg()"><option value="">-- 选择配置 --</option></select>
                               <button class="btn-action btn-danger" style="margin-left:5px; padding:6px;" onclick="apis.deleteCfg()">🗑️</button>
                          </div>

                          <div class="form-wide">
                              <span class="lbl-info" style="font-size:11px;">配置名称 (保存时必填)</span>
                              <input class="in-field form-wide" id="cfg_name" placeholder="例如: DeepSeek, GPT-4..."> 
                          </div>

                          <div class="form-wide" style="margin-top:10px;">
                              <span class="lbl-info" style="font-size:11px;">端点(API EP)，不要包含额外的空格</span>
                              <input class="in-field form-wide is-code" id="api_url" placeholder="https://api.openai-proxy.xyz"> 
                          </div>
                      
                           <div class="form-wide">
                                <span class="lbl-info" style="font-size:11px; color:#ff7675;">Key (SK-...), Auto Hidden</span>
                                <input type="password" class="in-field form-wide" id="api_key" placeholder="sk-.......">
                           </div>
                           
                           <!-- PULL MODELS Trigger -->
                           <div class="list-row" style="margin-top:10px; border:0; padding:0; gap:8px;">
                                 <select class="in-field" style="flex:1;" id="model_selector">
                                      <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                      <option value="gpt-4">gpt-4</option>
                                 </select>
                                 <button class="btn-action" title="Fetch Remote Models using JS Fetch" role="button" onclick="apis.pullRealModels()">🔄 拉取模型</button>
                           </div>

                           <div style="margin-top:20px; text-align:right;"> 
                                 <button class="btn-action btn-save" style="width:100%" onclick="apis.saveCfg()">✅ 保存当前配置</button>
                           </div>
                     </div>
                </div>

                <!-- CARD 4: UI BEAUTIFY -->
                <div class="st-card">
                    <div class="st-title-label">🎨 UI 美化工坊 (Beautify)</div>
                    <div style="font-size:10px; color:#999; margin-bottom:10px;">支持 本地图片 (File) 或 网络链接 (URL)</div>

                    <!-- Nav Bar -->
                    <div class="list-row" style="flex-wrap:wrap">
                        <div class="lbl-info form-wide">顶栏背景 (Nav Bar)</div>
                        <div style="width:100%; display:flex; gap:5px; margin-top:5px;">
                            <button class="btn-action btn-secondary" style="position:relative; width:40px;">
                                📂 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setFile(&#39;nav&#39;, this)">
                            </button>
                            <input class="in-field" style="flex:1" placeholder="https://..." onchange="themeMgr.setUrl(&#39;nav&#39;, this.value)">
                        </div>
                    </div>

                    <!-- Chat Bubble Me -->
                    <div class="list-row" style="flex-wrap:wrap">
                        <div class="lbl-info form-wide">我的气泡 (My Bubble)</div>
                        <div style="width:100%; display:flex; gap:5px; margin-top:5px;">
                             <button class="btn-action btn-secondary" style="position:relative; width:40px;">
                                📂 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setFile(&#39;bubbleMe&#39;, this)">
                            </button>
                            <input class="in-field" style="flex:1" placeholder="Color or URL..." onchange="themeMgr.setUrl(&#39;bubbleMe&#39;, this.value)">
                        </div>
                    </div>
                    
                    <!-- Chat Bubble Other -->
                    <div class="list-row" style="flex-wrap:wrap">
                        <div class="lbl-info form-wide">对方气泡 (Other Bubble)</div>
                        <div style="width:100%; display:flex; gap:5px; margin-top:5px;">
                             <button class="btn-action btn-secondary" style="position:relative; width:40px;">
                                📂 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setFile(&#39;bubbleOther&#39;, this)">
                            </button>
                            <input class="in-field" style="flex:1" placeholder="Color or URL..." onchange="themeMgr.setUrl(&#39;bubbleOther&#39;, this.value)">
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="list-row" style="flex-wrap:wrap">
                        <div class="lbl-info form-wide">底部输入框 (Input Area)</div>
                        <div style="width:100%; display:flex; gap:5px; margin-top:5px;">
                             <button class="btn-action btn-secondary" style="position:relative; width:40px;">
                                📂 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setFile(&#39;footer&#39;, this)">
                            </button>
                            <input class="in-field" style="flex:1" placeholder="Color or URL..." onchange="themeMgr.setUrl(&#39;footer&#39;, this.value)">
                        </div>
                    </div>

                    <!-- Avatar Radius -->
                    <div class="list-row">
                        <span class="lbl-info">头像形状 (Avatar Shape)</span>
                        <select class="in-field" onchange="themeMgr.setRadius(this.value)">
                            <option value="50%">圆形 (Circle)</option>
                            <option value="8px">圆角 (Rounded)</option>
                            <option value="0px">方形 (Square)</option>
                        </select>
                    </div>

                    <!-- Icon Replacement Section -->
                    <div style="margin-top:20px; border-top:1px dashed #eee; padding-top:10px;">
                        <div class="st-title-label" style="color:#6c5ce7">图标替换 (SVG Replacement)</div>
                        <div class="list-row" style="flex-wrap:wrap; gap:10px; justify-content:flex-start;">
                             <!-- Loop for common icons -->
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-back"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-back&#39;, this)" title="替换返回图标">
                             </button>
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-add"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-add&#39;, this)" title="替换添加图标">
                             </button>
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-menu"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-menu&#39;, this)" title="替换菜单图标">
                             </button>
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-face"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-face&#39;, this)" title="替换表情图标">
                             </button>
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-send"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-send&#39;, this)" title="替换发送图标">
                             </button>
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-msg"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-msg&#39;, this)" title="替换消息图标">
                             </button>
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-friends"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-friends&#39;, this)" title="替换好友图标">
                             </button>
                             <button class="btn-action btn-secondary" style="position:relative; width:40px; height:40px; display:flex; justify-content:center; align-items:center;">
                                 <svg class="svg-icon"><use href="#icon-star"></use></svg>
                                 <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="themeMgr.setIcon(&#39;icon-star&#39;, this)" title="替换动态图标">
                             </button>
                        </div>
                        <div style="font-size:10px; color:#aaa; margin-top:5px;">点击图标上传图片进行替换</div>
                    </div>

                  <div style="margin-top:20px; border-top:1px dashed #eee; padding-top:10px;">
    <div class="st-title-label" style="color:#6c5ce7">全局 CSS 代码 (Global CSS)</div>
    <div style="font-size:10px; color:#aaa; margin-bottom:5px;">输入代码后点击生效，会自动保存</div>
    <textarea id="myCustomCss" class="in-field" style="width:100%; height:100px; font-family:monospace; font-size:12px; resize:vertical;" placeholder="例如: .app-item { filter: grayscale(1); }"></textarea>
    <div style="text-align:left; margin-top:5px;">
         <button class="btn-action btn-green" onclick="runCustomCss()">⚡ 立即生效 (Apply)</button>
    </div>
</div>
                  
                    <div style="margin-top:-28px; text-align:right;">
                        <button class="btn-action btn-danger" onclick="themeMgr.reset()">↺ 重置默认</button>
                    </div>
                </div>

                <!-- CARD 5: Data -->
                  <div class="st-card">
                       <div class="st-title-label">Data Station (存档) </div>
                       
                        <!-- EXPORT -->
                        <div class="list-row">
                             <div class="lbl-info">导出配置 JSON<span class="row-sub">Export Backup File</span></div>
                             <button class="btn-action logibtn" onclick="dataCenter.exportConfig()">📥 导出</button>
                        </div>
                        
                         <!-- IMPORT BUTTON -->
                         <div class="list-row">
                            <div class="lbl-info">从文件导入<span class="row-sub">Recover .json</span></div>
                            <button class="btn-action btn-save" style="position:relative; background:#636e72;">
                                📤 上传恢复
                                <input type="file" accept=".json" onchange="dataCenter.importInUI(event)" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                            </button>
                       </div>

                       <!-- CLEAR DATA BUTTON -->
                       <div class="list-row" style="border-top: 1px dashed #eee; margin-top: 10px; padding-top: 10px;">
                            <div class="lbl-info" style="color:#ff7675;">清除所有数据<span class="row-sub">Clear All Data</span></div>
                            <button class="btn-action btn-danger" onclick="dataCenter.clearAllData()">🗑️ 清除</button>
                       </div>
                        
                  </div>
                    
                <br>
             </div>
        </div>

        <!-- :::: Layer 3: QQ App List :::: -->
        <div class="app-window-layer qq-app-layer visible" id="winQQList" style="display: flex;">
<div class="qq-nav-bar" id="qqMainNavBar">
     <div class="qq-btn-icon" onclick="appHub.exit()"><svg class="svg-icon"><use href="#icon-back"></use></svg></div>
     <div class="qq-title" id="qqMainTitle">消息</div>
     <div class="qq-btn-icon" onclick="qqApp.showContactModal()"><svg class="svg-icon"><use href="#icon-add"></use></svg></div>
</div>
            
            <div class="qq-content-area">
                <!-- Tab 1: Messages -->
                <div class="tab-view active" id="tabViewMsg">
                    <div class="qq-search-bar">
                        <input type="text" placeholder="搜索">
                    </div>
                    <div id="qqChatList"></div>
                </div>

                <!-- Tab 2: Contacts -->
                <div class="tab-view" id="tabViewContact">
                    <div class="qq-search-bar">
                        <input type="text" placeholder="搜索好友/群聊">
                    </div>
                    <div class="contact-menu-row">新朋友</div>
                    <div class="contact-menu-row">群通知</div>
                    <div id="contactListGrouped">
                        <!-- Dynamic Groups -->
                    </div>
                </div>

                <!-- Tab 3: Moments (Qzone) -->
                <div class="tab-view" id="tabViewMoment" style="background:#fff;">
                     <div class="qzone-cover-header" id="qzCoverBox" onclick="qqMoments.changeCover()">
                         <div class="qzone-cover-overlay"></div>
                         <div style="position:absolute; top:35px; right:15px; color:#fff; z-index:50; font-size:14px; font-weight:600; background:rgba(0,0,0,0.3); padding:4px 10px; border-radius:4px; backdrop-filter:blur(5px);" onclick="event.stopPropagation(); qqMoments.openPublish()">+ 发动态</div>
                         <div class="qzone-user-entry">
                             <div class="qzone-nick" id="qzNick" onclick="event.stopPropagation(); qqMoments.changeNick()">我</div>
                             <img class="qzone-avatar" id="qzAvt" onclick="event.stopPropagation(); qqMoments.changeAvatar()">
                         </div>
                     </div>
                     <div id="momentsList" style="padding-bottom:20px;">
                         <!-- Dynamic -->
                     </div>
                     
                     <!-- Hidden Inputs for Qzone Customization -->
                     <input type="file" id="qzCoverFile" accept="image/*" style="display:none" onchange="qqMoments.handleFile(this, &#39;cover&#39;)">
                     <input type="file" id="qzAvtFile" accept="image/*" style="display:none" onchange="qqMoments.handleFile(this, &#39;avatar&#39;)">
                </div>
            </div>

            <div class="qq-tab-bar">
                <div class="qq-tab-item active" id="barItemMsg" onclick="qqApp.switchMainTab(&#39;msg&#39;)"><span class="qq-tab-icon"><svg class="svg-icon"><use href="#icon-msg"></use></svg></span>消息</div>
                <div class="qq-tab-item" id="barItemContact" onclick="qqApp.switchMainTab(&#39;contact&#39;)"><span class="qq-tab-icon"><svg class="svg-icon"><use href="#icon-friends"></use></svg></span>联系人</div>
                <div class="qq-tab-item" id="barItemMoment" onclick="qqApp.switchMainTab(&#39;moment&#39;)"><span class="qq-tab-icon"><svg class="svg-icon"><use href="#icon-star"></use></svg></span>动态</div>
            </div>
        </div>

        <!-- :::: Layer 4: QQ Chat Detail :::: -->
        <div class="chat-window visible" id="winQQChat">
            <div class="qq-nav-bar">
                <div class="qq-btn-icon" onclick="qqApp.closeChat()"><svg class="svg-icon"><use href="#icon-back"></use></svg></div>
                <div class="qq-title" id="chatTitle">1</div>
                <div class="qq-btn-icon" onclick="chatSettings.open()"><svg class="svg-icon"><use href="#icon-menu"></use></svg></div>
            </div>

            <div class="chat-body" id="chatBody" onclick="qqApp.closeEmojiPanel()"></div>
            
            <!-- Context Menu -->
            <div class="msg-context-menu" id="msgMenu">
                <div class="msg-menu-item" onclick="qqApp.menuAction(&#39;copy&#39;)">复制</div>
                <div class="msg-menu-item" onclick="qqApp.menuAction(&#39;edit&#39;)">编辑</div>
                <div class="msg-menu-item" onclick="qqApp.menuAction(&#39;delete&#39;)">删除</div>
                <div class="msg-menu-item" onclick="qqApp.menuAction(&#39;recall&#39;)">撤回</div>
                <div class="msg-menu-item" id="btnTranscribe" onclick="qqApp.menuAction(&#39;transcribe&#39;)" style="display:none">转文字</div>
            </div>

            <div class="chat-footer">
                <button class="chat-btn" onclick="qqApp.toggleEmojiPanel()"><svg class="svg-icon"><use href="#icon-face"></use></svg></button>
                <button class="chat-btn" onclick="chatTools.togglePanel()"><svg class="svg-icon"><use href="#icon-plus-c"></use></svg></button>
                <textarea class="chat-input" id="chatInput" rows="1" onclick="qqApp.closeAllPanels()" onkeydown="if(event.key===&#39;Enter&#39; &amp;&amp; !event.shiftKey){event.preventDefault(); qqApp.sendText();}"></textarea>
                <button class="chat-btn btn-ai-wait" id="btnAI" onclick="qqApp.triggerAI()" title="让AI回复"><svg class="svg-icon"><use href="#icon-star"></use></svg></button>
                <button class="btn-send" onclick="qqApp.sendText()"><svg class="svg-icon"><use href="#icon-send"></use></svg></button>
            </div>
            
            <!-- Emoji Panel -->
            <div class="emoji-panel" id="emojiPanel">
                 <div class="emoji-toolbar">
                     <button class="btn-action btn-secondary" style="font-size:10px; padding:4px 8px;" onclick="document.getElementById(&#39;emojiInput&#39;).click()">+ 导入表情包 (多选)</button>
                     <button class="btn-action btn-secondary" style="font-size:10px; padding:4px 8px;" onclick="qqApp.importEmojiUrl()">+ 网络表情</button>
                     <button class="btn-action btn-danger" style="font-size:10px; padding:4px 8px; margin-left:auto;" onclick="qqApp.clearEmojis()">清空</button>
                 </div>
                 <div class="emoji-grid" id="emojiGrid"></div>
                 <input type="file" id="emojiInput" multiple="" accept="image/*" style="display:none" onchange="qqApp.handleEmojiUpload(this)">
            </div>

            <!-- Tools Panel -->
            <div class="chat-tools-panel open" id="toolsPanel">
                <div class="tool-item" onclick="chatTools.openTool(&#39;phone&#39;)">
                    <div class="tool-icon-box"><svg class="svg-icon"><use href="#icon-tool-phone"></use></svg></div>
                    <div class="tool-name">浏览记录</div>
                </div>
                <div class="tool-item" onclick="chatTools.openTool(&#39;purchase&#39;)">
                    <div class="tool-icon-box" style="color:#ff9f43"><svg class="svg-icon"><use href="#icon-tool-cart"></use></svg></div>
                    <div class="tool-name">购买记录</div>
                </div>
                <div class="tool-item" onclick="chatTools.openTool(&#39;cart&#39;)">
                    <div class="tool-icon-box" style="color:#ff6b6b"><svg class="svg-icon"><use href="#icon-tool-cart"></use></svg></div>
                    <div class="tool-name">购物车</div>
                </div>
                <div class="tool-item" onclick="chatTools.openTool(&#39;track&#39;)">
                    <div class="tool-icon-box" style="color:#2e86de"><svg class="svg-icon"><use href="#icon-tool-map"></use></svg></div>
                    <div class="tool-name">查轨迹</div>
                </div>
                <div class="tool-item" onclick="chatTools.openTool(&#39;music&#39;)">
                    <div class="tool-icon-box" style="color:#1dd1a1"><svg class="svg-icon"><use href="#icon-tool-music"></use></svg></div>
                    <div class="tool-name">一起听</div>
                </div>
                <div class="tool-item" onclick="callApp.startCall(&#39;voice&#39;)">
                    <div class="tool-icon-box" style="color:#00d2d3"><svg class="svg-icon"><use href="#icon-call-voice"></use></svg></div>
                    <div class="tool-name">语音通话</div>
                </div>
                <div class="tool-item" onclick="callApp.startCall(&#39;video&#39;)">
                    <div class="tool-icon-box" style="color:#5f27cd"><svg class="svg-icon"><use href="#icon-call-video"></use></svg></div>
                    <div class="tool-name">视频通话</div>
                </div>
                <div class="tool-item" onclick="chatTools.sendUserVoice()">
                    <div class="tool-icon-box" style="color:#a55eea"><svg class="svg-icon"><use href="#icon-voice"></use></svg></div>
                    <div class="tool-name">发语音</div>
                </div>
                <div class="tool-item" onclick="chatTools.sendImage()">
                    <div class="tool-icon-box" style="color:#0984e3">🖼️</div>
                    <div class="tool-name">发送图片</div>
                </div>
                <div class="tool-item" onclick="document.getElementById(&#39;chatPhotoInput&#39;).click()">
                    <div class="tool-icon-box" style="color:#6c5ce7">📷</div>
                    <div class="tool-name">发送照片</div>
                </div>
                <div class="tool-item" onclick="qqApp.triggerReRoll()">
                    <div class="tool-icon-box" style="color:#ff7675">🎲</div>
                    <div class="tool-name">重Roll</div>
                </div>
                <input type="file" id="chatPhotoInput" accept="image/*" style="display:none" onchange="chatTools.handlePhoto(this)">
            </div>
            
            <!-- Chat Settings Page (Slide in) -->
            <div class="chat-setting-page" id="winChatSet">
                 <div class="qq-nav-bar">
                     <div class="qq-btn-icon" onclick="chatSettings.close()"><svg class="svg-icon"><use href="#icon-back"></use></svg></div>
                     <div class="qq-title">聊天信息</div>
                     <div class="qq-btn-icon" style="opacity:0"></div>
                 </div>
                 <div class="cs-scroll">
                      <div class="cs-avatar-grid" id="csMembers"></div>
                      
                      <div class="cs-group">
                           <div class="cs-row">
                               <span>聊天名称</span>
                               <span class="cs-row-arrow" onclick="chatSettings.editTitle()"><span id="csTitleVal">1</span> &gt;</span>
                           </div>
                           <div class="cs-row">
                               <span>查找聊天记录</span>
                               <span class="cs-row-arrow">&gt;</span>
                           </div>
                      </div>

                      <div class="cs-group">
                           <div class="cs-row">
                               <span>消息免打扰</span>
                               <label class="toggle-switch-lab"><input type="checkbox" class="toggle-check"><span class="my-slider-t" style="height:24px;"></span></label>
                           </div>
                           <div class="cs-row">
                               <span>置顶聊天</span>
                               <label class="toggle-switch-lab"><input type="checkbox" class="toggle-check"><span class="my-slider-t" style="height:24px;"></span></label>
                           </div>
                           <div class="cs-row">
                               <span>强提醒</span>
                               <label class="toggle-switch-lab"><input type="checkbox" class="toggle-check"><span class="my-slider-t" style="height:24px;"></span></label>
                           </div>
                           <div class="cs-row">
                               <span>AI 读取表情包内容</span>
                               <label class="toggle-switch-lab"><input type="checkbox" class="toggle-check" id="tg_ai_emoji" checked=""><span class="my-slider-t" style="height:24px;"></span></label>
                           </div>
                           <div class="cs-row">
                               <span>后台自动回复</span>
                               <label class="toggle-switch-lab"><input type="checkbox" class="toggle-check" id="tg_auto_reply" onchange="chatSettings.toggleAutoReply(this)"><span class="my-slider-t" style="height:24px;"></span></label>
                           </div>
                           <div class="cs-row" id="row_auto_reply_freq" style="display:none">
                               <span>唤醒频率</span>
                               <select class="in-field" id="sel_auto_reply_freq" onchange="chatSettings.changeAutoReplyFreq(this)" style="width:100px; padding:4px;">
                                   <option value="600000">10分钟</option>
                                   <option value="1800000">30分钟</option>
                                   <option value="10800000">3小时</option>
                                   <option value="43200000">12小时</option>
                                   <option value="86400000">24小时</option>
                               </select>
                           </div>
                      </div>

                      <div class="cs-group">
                           <div class="cs-row" onclick="chatSettings.setBg()">
                               <span>设置当前聊天背景</span>
                               <span class="cs-row-arrow">&gt;</span>
                               <input type="file" id="csBgInput" accept="image/*" style="display:none" onchange="chatSettings.handleBg(this)">
                           </div>
                           <div class="cs-row" onclick="document.getElementById(&#39;csCallBgOther&#39;).click()">
                               <span>设置视频通话背景 (对方)</span>
                               <span class="cs-row-arrow">&gt;</span>
                               <input type="file" id="csCallBgOther" accept="image/*" style="display:none" onchange="chatSettings.handleCallBg(this, &#39;other&#39;)">
                           </div>
                           <div class="cs-row" onclick="document.getElementById(&#39;csCallBgMe&#39;).click()">
                               <span>设置视频通话背景 (我)</span>
                               <span class="cs-row-arrow">&gt;</span>
                               <input type="file" id="csCallBgMe" accept="image/*" style="display:none" onchange="chatSettings.handleCallBg(this, &#39;me&#39;)">
                           </div>
                      </div>

                      <div class="cs-group">
                           <div class="cs-row" style="color:#ff4757; justify-content:center;" onclick="chatSettings.clearHistory()">清空聊天记录</div>
                           <div class="cs-row" style="color:#ff4757; justify-content:center; border-top:1px solid #eee;" onclick="chatSettings.deleteChat()">删除好友/退出群聊</div>
                      </div>
                 </div>
            </div>
        </div>

        <!-- :::: Layer 5: Persona App :::: -->
        <div class="app-window-layer" id="winPersona" style="display: none;">
            <div class="app-nav">
                <h1 class="nav-title">人设工坊</h1>
                <button class="btn-nav-back" onclick="appHub.exit()"><svg class="svg-icon"><use href="#icon-back"></use></svg> 返回</button>
            </div>
            <div class="psn-tabs">
                <div class="psn-tab active" id="tabAI" onclick="personaApp.switchTab(&#39;ai&#39;)">AI 人设</div>
                <div class="psn-tab " id="tabUser" onclick="personaApp.switchTab(&#39;user&#39;)">User 人设</div>
            </div>
            <div class="psn-list" id="psnList"></div>
            <div class="fab-add" onclick="personaApp.openCreateModal()"><svg class="svg-icon" style="width:28px;height:28px;"><use href="#icon-add"></use></svg></div>
        </div>

        <!-- :::: Layer 6: WorldBook App :::: -->
        <div class="app-window-layer" id="winWorldBook" style="display: none;">
            <div class="app-nav" style="background: rgba(255,255,255,0.85);">
                <h1 class="nav-title" style="color:#00cace">世界书</h1>
                <button class="btn-nav-back" onclick="appHub.exit()"><svg class="svg-icon"><use href="#icon-back"></use></svg> 返回</button>
            </div>
            <div class="wb-list" id="wbList">
                <!-- Dynamic Content -->
            </div>
            <div class="fab-add fab-wb" onclick="wbApp.openCreateModal()"><svg class="svg-icon" style="width:28px;height:28px;"><use href="#icon-add"></use></svg></div>
        </div>

        <!-- :::: Layer 7: Weibo App :::: -->
        <div class="app-window-layer" id="winWeibo" style="display: none;">
            <div class="app-nav" style="background: #fff; border-bottom:1px solid #eee; justify-content:center; position:relative;">
                <button class="btn-nav-back" onclick="appHub.exit()" style="position:absolute; left:15px;">返回</button>
                <div class="wb-nav-tabs">
                    <div class="wb-nav-tab " id="wbTabHome" onclick="weiboApp.switchTab(&#39;home&#39;)">首页</div>
                    <div class="wb-nav-tab " id="wbTabHot" onclick="weiboApp.switchTab(&#39;hot&#39;)">热搜</div>
                    <div class="wb-nav-tab active" id="wbTabFollow" onclick="weiboApp.switchTab(&#39;follow&#39;)">关注</div>
                </div>
            </div>
            
            <!-- Home Feed View -->
            <div class="wb-feed" id="weiboHome" style="display: none;">
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding-top:100px; gap:15px;">
                    <div style="font-size:40px; color:#ddd;">🤖</div>
                    <div style="color:#999; font-size:14px;">AI 将为您实时创作内容</div>
                    <button class="btn-action" style="background:#ff8200; padding:8px 20px; font-size:14px; border-radius:20px;" onclick="weiboApp.generateFeed(&#39;home&#39;)">生成首页推荐</button>
                </div>
            </div>

            <!-- Hot Search View -->
            <div class="wb-hot-list" id="weiboHotSearch" style="display: none;">
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding-top:100px; gap:15px;">
                    <div style="font-size:40px; color:#ddd;">🤖</div>
                    <div style="color:#999; font-size:14px;">AI 将为您实时创作内容</div>
                    <button class="btn-action" style="background:#ff8200; padding:8px 20px; font-size:14px; border-radius:20px;" onclick="weiboApp.generateHotSearch()">生成热搜榜</button>
                </div>
            </div>

            <!-- Follow Feed View -->
            <div class="wb-feed" id="weiboFollow" style="display: block;">
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding-top:100px; gap:15px;">
                    <div style="font-size:40px; color:#ddd;">🤖</div>
                    <div style="color:#999; font-size:14px;">AI 将为您实时创作内容</div>
                    <button class="btn-action" style="background:#ff8200; padding:8px 20px; font-size:14px; border-radius:20px;" onclick="weiboApp.generateFeed(&#39;follow&#39;)">生成关注动态</button>
                </div>
            </div>
            
            <!-- FAB Publish -->
            <div class="fab-add" style="background:#ff8200; bottom:20px; right:20px;" onclick="weiboApp.openPublish()">
                <svg class="svg-icon" style="color:#fff"><use href="#icon-add"></use></svg>
            </div>

            <!-- Detail Layer (Post) -->
            <div class="wb-detail-layer" id="winWeiboDetail">
                 <div class="qq-nav-bar" style="background:#fff; border-bottom:1px solid #eee; height:50px; padding-top:0;">
                     <div class="qq-btn-icon" onclick="weiboApp.closeLayer(&#39;winWeiboDetail&#39;)" style="color:#333"><svg class="svg-icon"><use href="#icon-back"></use></svg></div>
                     <div class="qq-title" style="color:#333; font-size:16px;">微博正文</div>
                     <div style="width:30px"></div>
                 </div>
                 <div class="wb-comment-list" id="weiboDetailBody"></div>
            </div>

            <!-- Topic Layer -->
            <div class="wb-detail-layer" id="winWeiboTopic">
                 <div class="qq-nav-bar" style="background:transparent; position:absolute; top:0; left:0; width:100%; z-index:10;">
                     <div class="qq-btn-icon" onclick="weiboApp.closeLayer(&#39;winWeiboTopic&#39;)" style="color:#fff"><svg class="svg-icon"><use href="#icon-back"></use></svg></div>
                 </div>
                 <div class="wb-comment-list" id="weiboTopicBody" style="background:#f2f2f2"></div>
            </div>

            <!-- Profile Layer -->
            <div class="wb-detail-layer" id="winWeiboProfile">
                 <div class="qq-nav-bar" style="background:transparent; position:absolute; top:0; left:0; width:100%; z-index:10;">
                     <div class="qq-btn-icon" onclick="weiboApp.closeLayer(&#39;winWeiboProfile&#39;)" style="color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.5);"><svg class="svg-icon"><use href="#icon-back"></use></svg></div>
                 </div>
                 <div class="wb-comment-list" id="weiboProfileBody" style="background:#f2f2f2"></div>
            </div>
        </div>

        <!-- Weibo Publish Modal -->
        <div class="modal-overlay" id="modalWeiboPub">
            <div class="modal-panel" style="height:auto; border-radius: 20px;">
                <div class="modal-header">
                    <span onclick="document.getElementById(&#39;modalWeiboPub&#39;).classList.remove(&#39;visible&#39;)" style="font-weight:400; font-size:14px; color:#666">取消</span>
                    <span>发微博</span>
                    <span style="color:#ff8200; font-size:14px; font-weight:700" onclick="weiboApp.doPublish()">发送</span>
                </div>
                <div class="modal-list">
                    <textarea class="modal-input-area" id="wbPubInput" placeholder="分享新鲜事..."></textarea>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div class="wb-pub-img-btn" onclick="document.getElementById(&#39;wbPubFile&#39;).click()">+ 图片</div>
                        <img id="wbPubPreview" style="width:60px; height:60px; object-fit:cover; display:none; border-radius:4px;">
                        <input type="file" id="wbPubFile" accept="image/*" style="display:none" onchange="weiboApp.handlePubImage(this)">
                    </div>
                </div>
            </div>
        </div>

        <!-- :::: Tool Layers :::: -->
        
        <!-- Generic List Layer (Phone, Cart, etc) -->
        <div class="tool-layer" id="winGenericTool">
            <div class="app-nav" style="background:#fff; border-bottom:1px solid #eee;">
                <h1 class="nav-title" id="toolTitle">工具</h1>
                <button class="btn-nav-back" onclick="chatTools.closeTool()">返回</button>
            </div>
            <div class="tool-content" id="toolContent">
                 <div style="text-align:center; padding:50px; color:#999;">正在获取数据...</div>
            </div>
        </div>

        <!-- Listen Together Layer (NetEase Style) -->
        <div class="tool-layer" id="winListenTogether">
            <div class="music-player-ui">
                <div class="music-bg-blur" id="musicBg"></div>
                
                <div class="music-top-bar">
                    <div class="qq-btn-icon" onclick="chatTools.closeTool()"><svg class="svg-icon"><use href="#icon-back"></use></svg></div>
                    <div class="music-top-title">一起听</div>
                    <div class="qq-btn-icon" style="opacity:0"></div>
                </div>

                <div class="music-content">
                    <div class="music-avatars-box">
                        <img class="m-avt-halo" id="musicMeAvt">
                        <img class="m-avt-halo" id="musicOtherAvt">
                    </div>
                    <div class="music-disc-container">
                        <div class="music-disc" id="musicDisc">
                            <img class="music-cover" id="musicCover" src="https://via.placeholder.com/150">
                        </div>
                    </div>
                </div>

                <div class="music-info-area">
                    <div class="music-song-info">
                        <div class="music-song-title" id="musicTitle">未播放</div>
                        <div class="music-song-artist" id="musicArtist">-</div>
                    </div>
                    
                    <div class="music-ctrl-area">
                        <button class="btn-m-ctrl" style="font-size:20px;">♡</button>
                        <button class="btn-m-ctrl" onclick="musicPlayer.prev()">⏮</button>
                        <button class="btn-m-ctrl btn-m-play" id="btnPlay" onclick="musicPlayer.togglePlay()">▶</button>
                        <button class="btn-m-ctrl" onclick="musicPlayer.next()">⏭</button>
                        <button class="btn-m-ctrl" onclick="musicPlayer.togglePlaylist()">☰</button>
                    </div>
                </div>
                
                <!-- Playlist Drawer -->
                <div class="music-playlist-drawer" id="musicPlaylistDrawer">
                    <div class="mp-header">
                        <div class="mp-title">当前播放 <span id="mpCount">(0)</span></div>
                        <div class="qq-btn-icon" onclick="musicPlayer.togglePlaylist()">×</div>
                    </div>
                    <div class="mp-actions">
                        <button class="btn-mp-act" onclick="document.getElementById(&#39;musicFileIn&#39;).click()">
                            <span>📂</span> 本地导入
                        </button>
                        <button class="btn-mp-act" onclick="musicPlayer.addUrlSong()">
                            <span>🔗</span> 网络链接
                        </button>
                    </div>
                    <div class="mp-list" id="mpList">
                        <!-- Dynamic List -->
                    </div>
                </div>

                <audio id="realAudio" style="display:none"></audio>
                <input type="file" id="musicFileIn" multiple="" accept="audio/*" style="display:none" onchange="musicPlayer.handleFiles(this)">
            </div>
        </div>

        <!-- :::: Layer: Call Interface (Voice/Video) :::: -->
        <div class="call-layer" id="winCallLayer">
             <!-- Video Backgrounds -->
             <div class="call-bg-video" id="callBgOther" style="background-image:url(&#39;https://picsum.photos/400/800?1&#39;)"></div>
             
             <!-- Mini Window (Me) -->
             <div class="call-mini-window" id="callMiniWin" onclick="callApp.toggleCamera()">
                 <div class="call-bg-video" id="callBgMe" style="background-image:url(&#39;https://picsum.photos/400/800?2&#39;)"></div>
             </div>

             <!-- Main Content -->
             <div class="call-content">
             </div>

             <!-- Chat Bubbles Overlay -->
             <div class="call-chat-area" id="callChatArea"><div class="call-bubble-row me"><div class="call-bubble">wqwq</div></div></div>

             <!-- Input Area -->
             <div class="call-input-box" id="callInputBox">
                 <input class="call-input" id="callInput" placeholder="发送消息..." onkeydown="if(event.key===&#39;Enter&#39;) callApp.send()">
                 <button class="call-btn-send" onclick="callApp.send()"><svg class="svg-icon"><use href="#icon-send"></use></svg></button>
             </div>

             <!-- Footer Controls -->
             <div class="call-footer">
                 <button class="call-ctrl-btn" onclick="callApp.toggleMute()">
                     <svg class="svg-icon" style="width:24px;height:24px"><use href="#icon-voice"></use></svg>
                     <span class="call-ctrl-label">静音</span>
                 </button>
                 <button class="call-ctrl-btn hangup" onclick="callApp.endCall()">
                     <svg class="svg-icon" style="transform:rotate(135deg)"><use href="#icon-tool-phone"></use></svg>
                 </button>
                 <button class="call-ctrl-btn" onclick="callApp.toggleSpeaker()">
                     <svg class="svg-icon" style="width:24px;height:24px"><use href="#icon-tool-music"></use></svg>
                     <span class="call-ctrl-label">免提</span>
                 </button>
             </div>
        </div>

        <!-- :::: Modal: Contact Selector :::: -->
        <div class="modal-overlay" id="modalContact">
            <div class="modal-panel">
                <div class="modal-header">
                    <span onclick="qqApp.closeContactModal()" style="font-weight:400; font-size:14px; color:#666">取消</span>
                    <span>发起聊天</span>
                    <span style="color:#1890ff; font-size:14px;" onclick="qqApp.confirmCreateChat()">确定</span>
                </div>
                <div class="modal-list" id="contactListBody"></div>
            </div>
        </div>

        <!-- :::: Modal: Create Persona :::: -->
        <div class="modal-overlay" id="modalCreatePersona">
    <div class="modal-panel" style="height:auto; border-radius: 20px;">
        <div class="modal-header">
            <span id="btnPsnCancel" onclick="personaApp.closeCreateModal()" style="font-weight:400; font-size:14px; color:#666">取消</span>
            <span id="btnPsnDelete" onclick="personaApp.deletePersona()" style="font-weight:700; font-size:14px; color:#ff4757; display:none;">删除</span>
            
            <span id="createTitle">新建人设</span>
            
            <span style="color:#1890ff; font-size:14px; font-weight:700" onclick="personaApp.savePersona()">保存</span>
        </div>
        <div class="modal-list">
            <div class="avatar-uploader" id="pAvatarBox" onclick="document.getElementById(&#39;pFile&#39;).click()">
                <img id="pAvatarPreview" src="./Q萌手机-全员ICON自由版_files/碎纸机 - 副本 (2).html">
                <input type="file" id="pFile" accept="image/*" style="display:none" onchange="personaApp.handleFile(this)">
            </div>
            <div class="form-group">
                <label class="form-label">名字</label>
                <input type="text" class="form-input" id="pName" placeholder="给TA起个名字...">
            </div>
            <div class="form-group">
                <label class="form-label">人设描述</label>
                <textarea class="form-input" id="pDesc" placeholder="TA是什么性格？喜欢什么？..."></textarea>
            </div>
        </div>
    </div>
</div>

        <!-- :::: Modal: Create WorldBook :::: -->
        <div class="modal-overlay" id="modalCreateWB">
            <div class="modal-panel" style="height:auto; border-radius: 20px;">
                <div class="modal-header">
                    <span onclick="wbApp.closeCreateModal()" style="font-weight:400; font-size:14px; color:#666">取消</span>
                    <span>新建世界书</span>
                    <span style="color:#00cace; font-size:14px;" onclick="wbApp.saveEntry()">保存</span>
                </div>
                <div class="modal-list">
    <div style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #eee;">
        <button class="btn-action btn-secondary" onclick="document.getElementById(&#39;wbFileIn&#39;).click()" style="width:100%;">
            📂 从文件导入 (txt / docx / json)
        </button>
        <input type="file" id="wbFileIn" accept=".txt,.json,.docx" style="display:none" onchange="wbApp.handleImport(this)">
        <div style="font-size:10px; color:#aaa; margin-top:5px; text-align:center;">导入后会自动填充标题和内容，你仍可修改</div>
    </div>
    <div class="form-group">
        <label class="form-label">条目名 (Key)</label>
        <input type="text" class="form-input" id="wbName" placeholder="例如: 魔法系统, 学院背景...">
    </div>
    <div class="form-group">
        <label class="form-label">设定内容 (Content)</label>
        <textarea class="form-input" id="wbContent" style="height:150px" placeholder="在这里输入详细的设定内容，AI会记住这些信息..."></textarea>
    </div>
        </div>

        <!-- :::: Modal: Publish Moment :::: -->
        <div class="modal-overlay" id="modalPublishMoment">
            <div class="modal-panel" style="height:auto; border-radius: 20px;">
                <div class="modal-header">
                    <span onclick="qqMoments.closePublish()" style="font-weight:400; font-size:14px; color:#666">取消</span>
                    <span>发动态</span>
                    <span style="color:#00cace; font-size:14px; font-weight:700" onclick="qqMoments.doPublish()">发布</span>
                </div>
                <div class="modal-list">
                    <textarea class="modal-input-area" id="momInput" placeholder="分享新鲜事..."></textarea>
                    <div style="display:flex; gap:10px;">
                        <div style="width:60px; height:60px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:20px;"><svg class="svg-icon"><use href="#icon-add"></use></svg></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- :::: Layer LockScreen Slide :::: -->
        <d class="layer-lock" id="winLock">
             <div style="padding-top:20px; text-align:center; color:#fff;">
                  <span style="font-size:18px;" id="l_date">1月3日 今天</span><br>
                  <span style="font-size:80px; font-weight:800; line-height:1; letter-spacing: -3px; color:#537ea5;" id="l_time">13:44</span>
             </div>
             
             <!-- Lock-Widget -->
             <label for="wp_lk" style="margin-top:20px; width:220px; height:260px; background:rgba(255,255,255,0.4);border-radius:26px; border:3px solid rgba(255,255,255,0.7); backdrop-filter:blur(8px); display:flex; justify-content:center; align-items:center; overflow:hidden;" class="lock-wgt">
                 <span style="font-size:12px; color:#537ea5; font-weight:700">📸 LOCK WIGET + </span>
                 <img id="l_imgP" style="width:100%; height:100%; object-fit:cover; display:none;">
                 <input type="file" id="wp_lk" style="display:none" onchange="document.getElementById(&#39;l_imgP&#39;).src=window.URL.createObjectURL(this.files[0]);document.getElementById(&#39;l_imgP&#39;).style.display=&#39;block&#39;;">
             </label>

             <!-- Q Slider Logic Area -->
             <div class="slider-bar-lock">
                  <span class="slide-hint">→ SLIDE OPEN UI</span>
                  <!-- Using custom range css logic -->
                  <div class="real-handle" id="jellyBall" style="left: 0px;"></div>
                  <!-- Use absolute input over it -->
                  <input type="range" class="main-slider" min="0" max="100" value="0" id="sld_tk" oninput="document.getElementById(&#39;jellyBall&#39;).style.left =  (this.value/100 * (260-64)) + &#39;px&#39;">
             </div>
        </d>

</div> 
</div> <!-- Device End -->

<!-- JS SECTION -->
<script>
    /* IndexedDB Wrapper for Emoji Storage */
    const db = {
        dbName: 'QQ_Emoji_DB',
        version: 1,
        storeName: 'emojis',
        init: () => {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(db.dbName, db.version);
                req.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(db.storeName)) {
                        database.createObjectStore(db.storeName, { keyPath: 'id', autoIncrement: true });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        },
        add: async (data) => {
            try {
                const database = await db.init();
                return new Promise((resolve, reject) => {
                    const tx = database.transaction(db.storeName, 'readwrite');
                    const store = tx.objectStore(db.storeName);
                    const req = store.add(data); 
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            } catch(e) { console.error(e); }
        },
        getAll: async () => {
            try {
                const database = await db.init();
                return new Promise((resolve, reject) => {
                    const tx = database.transaction(db.storeName, 'readonly');
                    const store = tx.objectStore(db.storeName);
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            } catch(e) { return []; }
        },
        clear: async () => {
            try {
                const database = await db.init();
                return new Promise((resolve, reject) => {
                    const tx = database.transaction(db.storeName, 'readwrite');
                    const store = tx.objectStore(db.storeName);
                    const req = store.clear();
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            } catch(e) { console.error(e); }
        }
    };

    /* Refs */
    const appS = document.getElementById('winSet');
    const appQQ = document.getElementById('winQQList');
    const appPsn = document.getElementById('winPersona');
    const appWB = document.getElementById('winWorldBook');
    const dsk = document.getElementById('sceneDesktop');
    const phone = document.getElementById('smartDevice');

    /* Navigation */
    const appHub = {
        openS: (pid) => {
            dsk.classList.add('apps-open'); 
            if(pid === 'set') { 
                appS.style.display = 'flex';
                setTimeout(()=> appS.classList.add('visible'), 50);
            } else if (pid === 'qq') {
                appQQ.style.display = 'flex';
                setTimeout(()=> appQQ.classList.add('visible'), 50);
                qqApp.renderChatList();
            } else if (pid === 'psn') {
                appPsn.style.display = 'flex';
                setTimeout(()=> appPsn.classList.add('visible'), 50);
                personaApp.renderList();
            } else if (pid === 'wb') {
                appWB.style.display = 'flex';
                setTimeout(()=> appWB.classList.add('visible'), 50);
                wbApp.renderList();
            } else if (pid === 'weibo') {
                document.getElementById('winWeibo').style.display = 'flex';
                setTimeout(()=> document.getElementById('winWeibo').classList.add('visible'), 50);
                weiboApp.open();
            }
        },
        exit: () => {
             // Close all
             appS.classList.remove('visible');
             appQQ.classList.remove('visible');
             appPsn.classList.remove('visible');
             appWB.classList.remove('visible');
             document.getElementById('winWeibo').classList.remove('visible');
             
             setTimeout(()=>{ 
                 dsk.classList.remove('apps-open'); 
                 appS.style.display='none'; 
                 appQQ.style.display='none';
                 appPsn.style.display='none';
                 appWB.style.display='none';
                 document.getElementById('winWeibo').style.display='none';
             }, 300);
        }
    };

    /* Clock */
    setInterval(() => {
         const d = new Date(); var m=d.getMinutes(); var h=d.getHours();
         const tStr = (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m);
         document.getElementById('l_time').innerText = tStr; 
         document.getElementById('dkClk').innerText = tStr;
         document.getElementById('stTm').innerText = tStr;
         const dStr = (d.getMonth()+1)+"月"+ d.getDate()+"日";
         document.getElementById('l_date').innerText = dStr + " 今天";
         document.getElementById('dkDate').innerText = dStr;
    }, 1000);

    /* Unlocker */
    const uRng = document.getElementById('sld_tk');
    const uLock = document.getElementById('winLock');
    uRng.addEventListener('input', (e)=>{ 
        if(e.target.value>94){ 
            uLock.classList.add('open'); uRng.disabled=true;
         }
    });

    // Jelly Snap Back
    uRng.addEventListener('change', (e)=> { 
        if(e.target.value<94) {
            e.target.value=0; 
            document.getElementById('jellyBall').style.left = "0px";
        } 
    });

   /* ====== Run UI Tools ====== */
    const runUI = {
         toggleDark: (el) => { if(el.checked) phone.classList.add('dt-dark'); else phone.classList.remove('dt-dark');},
         
         setWall: (e) => {
             if(e.target.files[0]) dsk.style.backgroundImage = `url(${URL.createObjectURL(e.target.files[0])})`;
         },
         
         setUrlFont: () => {
              const u = document.getElementById('fturl').value; 
              if(u && u.startsWith('http')) {
                   const style = document.createElement('style');
                   style.innerHTML = `@font-face { font-family: 'RunUserFt'; src: url('${u}'); } * { font-family: 'RunUserFt', sans-serif !important; }`;
                   document.head.appendChild(style);
                  alert('URL Font Loaded.');
              }
         },

         changeFtSize: (r) => { appS.style.fontSize = (15 * r.value) + "px"; },

         iconRep: (id, e) => {
             const div = document.getElementById(id);
             const url = URL.createObjectURL(e.target.files[0]);
             div.innerText = "";
             div.style.background = "#fff"; 
             div.style.backgroundImage = `url(${url})`;
             div.style.backgroundSize = "cover";
             div.style.backgroundPosition = "center";
         }
    };


    /* ====== API Core (Fetch + Listing) ====== */
    const apis = {
        getCfgs: () => JSON.parse(localStorage.getItem('qq_api_configs_list') || '[]'),
        
        saveCfg: () => { 
            const name = document.getElementById('cfg_name').value.trim();
            if(!name) return alert("请填写配置名称！");

            const cfg = {
                name: name,
                url: document.getElementById('api_url').value,
                key: document.getElementById('api_key').value,
                model: document.getElementById('model_selector').value
            };
            
            // Save as current
            localStorage.setItem('qq_api_config', JSON.stringify(cfg));
            
            // Save to list
            let list = apis.getCfgs();
            const idx = list.findIndex(c => c.name === name);
            if(idx >= 0) list[idx] = cfg;
            else list.push(cfg);
            
            localStorage.setItem('qq_api_configs_list', JSON.stringify(list));
            apis.renderList(name);
            alert(`配置 [${name}] 已保存并应用！`); 
        },

        deleteCfg: () => {
            const sel = document.getElementById('cfg_list');
            const name = sel.value;
            if(!name) return;
            if(confirm(`确定删除配置 [${name}] 吗？`)) {
                let list = apis.getCfgs();
                list = list.filter(c => c.name !== name);
                localStorage.setItem('qq_api_configs_list', JSON.stringify(list));
                
                // Clear current if deleted
                const cur = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
                if(cur.name === name) {
                    localStorage.removeItem('qq_api_config');
                    document.getElementById('cfg_name').value = "";
                    document.getElementById('api_url').value = "";
                    document.getElementById('api_key').value = "";
                }
                apis.renderList();
            }
        },

        switchCfg: () => {
            const name = document.getElementById('cfg_list').value;
            if(!name) return;
            
            const list = apis.getCfgs();
            const cfg = list.find(c => c.name === name);
            if(cfg) {
                document.getElementById('cfg_name').value = cfg.name;
                document.getElementById('api_url').value = cfg.url;
                document.getElementById('api_key').value = cfg.key;
                
                // Handle Model
                const sel = document.getElementById('model_selector');
                if(![...sel.options].some(o=>o.value===cfg.model)) {
                     const o = document.createElement('option'); o.value = cfg.model; o.innerText = cfg.model; sel.appendChild(o);
                }
                sel.value = cfg.model;
                
                // Save as current implicitly
                localStorage.setItem('qq_api_config', JSON.stringify(cfg));
            }
        },

        renderList: (selectName) => {
            const list = apis.getCfgs();
            const sel = document.getElementById('cfg_list');
            sel.innerHTML = '<option value="">-- 选择配置 --</option>';
            list.forEach(c => {
                const o = document.createElement('option');
                o.value = c.name;
                o.innerText = c.name;
                if(selectName && c.name === selectName) o.selected = true;
                sel.appendChild(o);
            });
        },

        loadCfg: () => {
            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            if(cfg.url) document.getElementById('api_url').value = cfg.url;
            if(cfg.key) document.getElementById('api_key').value = cfg.key;
            if(cfg.name) document.getElementById('cfg_name').value = cfg.name;
            
            if(cfg.model) {
                 const sel = document.getElementById('model_selector');
                 if(![...sel.options].some(o=>o.value===cfg.model)) {
                     const o = document.createElement('option'); o.value = cfg.model; o.innerText = cfg.model; sel.appendChild(o);
                 }
                 sel.value = cfg.model;
            }
            apis.renderList(cfg.name);
        },

        pullRealModels: async () => {
             const url = document.getElementById('api_url').value; 
             const key = document.getElementById('api_key').value; 
             const sel = document.getElementById('model_selector'); 

             if(!url) return alert('Input API EndPoint!');
             sel.innerHTML = "<option>Finding...</option>";
            let ep = url.endsWith('/') ? url.slice(0,-1) : url;
            if(!ep.includes('/models')) ep += "/v1/models";

             try {
                const res = await fetch(ep, {
                     headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' }
                });
                if(!res.ok) throw new Error("Status " + res.status);
                
                const frame = await res.json();
                sel.innerHTML = "";
                const list = frame.data || frame.models || []; 
                
                if(list.length === 0){ sel.innerHTML="<option>No list got</option>"; return;}

                list.forEach(m => {
                      const o = document.createElement('option');
                      o.value = m.id; o.innerText = m.id;
                      sel.appendChild(o);
                });
                alert(`Yeet! Pulled ${list.length} models.`);

             } catch(err) {
                console.warn(err);
                alert("Connect Fail. Check CORS/Server availability.");
                sel.innerHTML = "<option>Error Fail</option>";
             } 
        }
    };

    /* Data Logic */   
    const dataCenter = {
         exportConfig: () => {
              const obj = { 
                  setting: "demo", 
                  chats: localStorage.getItem('qq_chats'),
                  api: localStorage.getItem('qq_api_config'),
                  ais: localStorage.getItem('saved_ai_personas'),
                  users: localStorage.getItem('saved_user_personas'),
                  wb: localStorage.getItem('worldbook_data')
              };
              const blob = new Blob([JSON.stringify(obj)], {type: "application/json"});
              const lk = document.createElement("a");
              lk.href = URL.createObjectURL(blob);
              lk.download = "OS_Backup.json";
              lk.click();
         },
         importInUI: (e) => {
              const f = e.target.files[0];
              if(!f) return;
              const r = new FileReader();
              r.onload = (loadEvt) => {
                   alert("JSON Content restored (Dummy Logic): \n" + loadEvt.target.result.substring(0,50) + "...");
                   // In real app we parse this and runUI.iconRep calls
              }; 
              r.readAsText(f);
         },
         clearAllData: () => {
             if(confirm("⚠️ 警告：这将清除所有聊天记录、人设、世界书、动态等所有数据，并恢复到初始状态！\n确定要继续吗？")) {
                 localStorage.clear();
                 alert("所有数据已清除，页面将刷新。");
                 location.reload();
             }
         },
    };

    /* ========================================================
       QQ CHAT CORE LOGIC (No Hardcoded Personas!)
       ======================================================== */
    const chatCore = {
        // 动态获取 LocalStorage 数据
        getAIs: () => JSON.parse(localStorage.getItem('saved_ai_personas') || '[]'),
        getUsers: () => JSON.parse(localStorage.getItem('saved_user_personas') || '[]'),
        getChats: () => JSON.parse(localStorage.getItem('qq_chats') || '[]'),
        
        saveChats: (chats) => localStorage.setItem('qq_chats', JSON.stringify(chats)),

        createChat: (title, members, userPersona) => {
            const chats = chatCore.getChats();
            const newChat = {
                id: 'c_' + Date.now(),
                title: title,
                members: members, // Array of AI objects
                userPersona: userPersona, // Current user persona
                messages: [],
                settings: { bg: null, note: null }, // New: Chat settings
                updatedAt: Date.now()
            };
            chats.unshift(newChat);
            chatCore.saveChats(chats);
            return newChat.id;
        },

        updateChatSettings: (chatId, key, val) => {
            const chats = chatCore.getChats();
            const chat = chats.find(c => c.id === chatId);
            if(chat) {
                if(!chat.settings) chat.settings = {};
                chat.settings[key] = val;
                // If changing note, also update title for consistency if it's a 1-on-1 or group name override
                if(key === 'note') chat.title = val;
                chatCore.saveChats(chats);
                return chat;
            }
        },

        deleteChat: (chatId) => {
            let chats = chatCore.getChats();
            chats = chats.filter(c => c.id !== chatId);
            chatCore.saveChats(chats);
        },

        addMsg: (chatId, role, content, type='text', senderName='') => {
            const chats = chatCore.getChats();
            const chat = chats.find(c => c.id === chatId);
            if(chat) {
                chat.messages.push({
                    id: 'msg_' + Date.now() + Math.random().toString(36).substr(2, 5),
                    role, content, type, senderName,
                    timestamp: Date.now()
                });
                chat.updatedAt = Date.now();
                const idx = chats.indexOf(chat);
                chats.splice(idx, 1);
                chats.unshift(chat);
                
                // Reset AutoReply Flag
                if(chat.settings) chat.settings.autoReplyTriggered = false;

                chatCore.saveChats(chats);
            }
        },

        deleteMsg: (chatId, msgId) => {
            const chats = chatCore.getChats();
            const chat = chats.find(c => c.id === chatId);
            if(chat) {
                chat.messages = chat.messages.filter(m => m.id !== msgId);
                chatCore.saveChats(chats);
            }
        },
        
        // Moments Data
        getMoments: () => JSON.parse(localStorage.getItem('qq_moments') || '[]'),
        saveMoments: (list) => localStorage.setItem('qq_moments', JSON.stringify(list)),
        addMoment: (moment) => {
            const list = chatCore.getMoments();
            list.unshift(moment);
            chatCore.saveMoments(list);
        },
        
        editMsg: (chatId, msgId, newContent) => {
            const chats = chatCore.getChats();
            const chat = chats.find(c => c.id === chatId);
            if(chat) {
                const msg = chat.messages.find(m => m.id === msgId);
                if(msg) {
                    msg.content = newContent;
                    chatCore.saveChats(chats);
                }
            }
        }
    };

    /* QQ UI Logic */
    const qqApp = {
        currentChatId: null,
        contactModalStep: 1,
        contactModalMode: 'private',
        
        switchMainTab: (tab) => {
            // tab: 'msg', 'contact', 'moment'
            document.querySelectorAll('.qq-tab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
            
            const nav = document.getElementById('qqMainNavBar');
            const title = document.getElementById('qqMainTitle');
            
            // Reset Nav
            nav.classList.remove('transparent');
            title.innerText = "";

            if(tab === 'msg') {
                document.getElementById('barItemMsg').classList.add('active');
                document.getElementById('tabViewMsg').classList.add('active');
                title.innerText = "消息";
                qqApp.renderChatList();
            } else if (tab === 'contact') {
                document.getElementById('barItemContact').classList.add('active');
                document.getElementById('tabViewContact').classList.add('active');
                title.innerText = "联系人";
                qqApp.renderContactList();
            } else if (tab === 'moment') {
                document.getElementById('barItemMoment').classList.add('active');
                document.getElementById('tabViewMoment').classList.add('active');
                title.innerText = "动态";
                nav.classList.add('transparent'); // Transparent header for Qzone cover
                qqMoments.render();
            }
        },

        renderChatList: () => {
            const list = chatCore.getChats();
            const container = document.getElementById('qqChatList');
            container.innerHTML = "";

            if(list.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:50px 20px; color:#aaa; font-size:13px;">
                    暂无消息<br>请点击右上角 + 发起聊天
                </div>`;
                return;
            }

            list.forEach(chat => {
                // Get last msg
                const lastMsg = chat.messages.length > 0 ? chat.messages[chat.messages.length-1] : {content: "暂无消息", timestamp: chat.updatedAt};
                const preview = lastMsg.type === 'image' ? '[图片]' : lastMsg.content;
                const avatar = (chat.members[0] && chat.members[0].avatar) ? chat.members[0].avatar : '';
                
                const el = document.createElement('div');
                el.className = 'chat-item';
                el.onclick = () => qqApp.openChat(chat.id);
                el.innerHTML = `
                    <img src="${avatar}" class="chat-avatar" onerror="this.style.background='#ccc'">
                    <div class="chat-info">
                        <div class="chat-name-row">
                            <span class="chat-name">${chat.title}</span>
                            <span class="chat-time">${new Date(lastMsg.timestamp).getHours()}:${(new Date(lastMsg.timestamp).getMinutes()<10?'0':'') + new Date(lastMsg.timestamp).getMinutes()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                             <div class="chat-msg-preview">${preview}</div>
                             ${chat.unread ? `<div class="chat-badge">${chat.unread}</div>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        },

        renderContactList: () => {
            const container = document.getElementById('contactListGrouped');
            container.innerHTML = "";
            const ais = chatCore.getAIs();
            
            const groups = [
                {name: "特别关心", list: []},
                {name: "群聊", list: []}, // Future: group logic
                {name: "我的好友", list: ais}
            ];

            groups.forEach(g => {
                const head = document.createElement('div');
                head.className = 'contact-group-header';
                head.innerText = `${g.name} (${g.list.length})`;
                head.onclick = () => {
                    head.classList.toggle('collapsed');
                    head.nextElementSibling.classList.toggle('collapsed');
                };
                container.appendChild(head);

                const listDiv = document.createElement('div');
                listDiv.className = 'contact-group-list';
                
                if(g.list.length === 0) {
                    listDiv.innerHTML = `<div style="padding:10px 15px; color:#ccc; font-size:12px;">无</div>`;
                } else {
                    g.list.forEach(ai => {
                        const item = document.createElement('div');
                        item.className = 'chat-item';
                        item.innerHTML = `
                             <img src="${ai.avatar}" class="chat-avatar" onerror="this.style.background='#ccc'">
                             <div class="chat-name">${ai.name}</div>
                        `;
                        // Click to create chat directly
                        item.onclick = () => {
                           // Find existing 1-on-1 chat or create new
                           const users = chatCore.getUsers();
                           const me = users[0]; 
                           if(!me) return alert("请先创建User人设");
                           
                           // Simplified: just create new for now, or check existing
                           // For demo, we just open contact modal logic or simple alert
                           alert(`点击了 ${ai.name}，请使用右上角 + 号发起聊天`);
                        };
                        listDiv.appendChild(item);
                    });
                }
                container.appendChild(listDiv);
            });
        },

        showContactModal: () => {
            qqApp.contactModalStep = 1;
            const modal = document.getElementById('modalContact');
            const body = document.getElementById('contactListBody');
            modal.classList.add('visible');
            
            // Render Step 1: Type Selection
            body.innerHTML = `
                <div style="display:flex; gap:15px; justify-content:center; padding:30px 0;">
                    <div onclick="qqApp.setContactMode('private')" style="padding:20px; background:#e6f7ff; border-radius:10px; border:1px solid #1890ff; color:#1890ff; font-weight:bold; cursor:pointer; width:120px; text-align:center; box-shadow:0 4px 10px rgba(24,144,255,0.1)">
                        👤 私聊<br><span style="font-size:10px; font-weight:normal; color:#666">1对1聊天</span>
                    </div>
                    <div onclick="qqApp.setContactMode('group')" style="padding:20px; background:#f6ffed; border-radius:10px; border:1px solid #52c41a; color:#52c41a; font-weight:bold; cursor:pointer; width:120px; text-align:center; box-shadow:0 4px 10px rgba(82,196,26,0.1)">
                         👥 群聊<br><span style="font-size:10px; font-weight:normal; color:#666">多人/单人剧本</span>
                    </div>
                </div>
                <div style="text-align:center; color:#999; font-size:12px;">请选择聊天类型</div>
            `;
        },
        
        setContactMode: (mode) => {
             qqApp.contactModalMode = mode;
             qqApp.contactModalStep = 2;
             qqApp.renderContactSelection();
        },

        renderContactSelection: () => {
             const ais = chatCore.getAIs();
             const users = chatCore.getUsers();
             const body = document.getElementById('contactListBody');
             body.innerHTML = "";
             
             // AI Section
             const aiSec = document.createElement('div');
             aiSec.className = 'contact-section';
             const isMulti = qqApp.contactModalMode === 'group';
             aiSec.innerHTML = `<div class="section-title">选择AI角色 (${isMulti ? '多选' : '单选'})</div>`;
             
             if(ais.length === 0) aiSec.innerHTML += `<div style="font-size:12px;color:#999;padding:10px;">暂无AI人设，请去[人设]APP添加</div>`;
             
             ais.forEach(ai => {
                const card = document.createElement('div');
                card.className = 'contact-card ai-card';
                card.dataset.id = ai.id;
                card.onclick = () => {
                    if(!isMulti) {
                        document.querySelectorAll('.ai-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    } else {
                        card.classList.toggle('selected');
                    }
                };
                card.innerHTML = `
                    <img src="${ai.avatar || ''}" onerror="this.style.background='#eee'">
                    <span class="contact-name">${ai.name}</span>
                    <div class="check-circle"></div>
                `;
                aiSec.appendChild(card);
             });
             body.appendChild(aiSec);

             // User Section
             const userSec = document.createElement('div');
             userSec.className = 'contact-section';
             userSec.innerHTML = `<div class="section-title">选择你的身份 (单选)</div>`;
             if(users.length === 0) userSec.innerHTML += `<div style="font-size:12px;color:#999;padding:10px;">暂无用户人设，请去[人设]APP添加</div>`;

             users.forEach(u => {
                const card = document.createElement('div');
                card.className = 'contact-card user-card';
                card.dataset.id = u.id;
                card.onclick = () => {
                    document.querySelectorAll('.user-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                };
                card.innerHTML = `
                    <img src="${u.avatar || ''}" onerror="this.style.background='#eee'">
                    <span class="contact-name">${u.name}</span>
                    <div class="check-circle"></div>
                `;
                userSec.appendChild(card);
             });
             body.appendChild(userSec);
        },

        closeContactModal: () => {
            document.getElementById('modalContact').classList.remove('visible');
        },

        confirmCreateChat: () => {
            if(qqApp.contactModalStep === 1) return alert("请先选择聊天类型");

            const ais = chatCore.getAIs();
            const users = chatCore.getUsers();
            
            const selectedAiIds = [...document.querySelectorAll('.ai-card.selected')].map(el => el.dataset.id);
            const selectedUserId = document.querySelector('.user-card.selected')?.dataset.id;

            if(selectedAiIds.length === 0) return alert('请至少选择一个AI角色');
            if(!selectedUserId) return alert('请选择你的身份');

            const selectedAIs = ais.filter(a => selectedAiIds.includes(a.id));
            const selectedUser = users.find(u => u.id === selectedUserId);
            
            // Check Duplication for Private Chat
            if(qqApp.contactModalMode === 'private') {
                const existingChats = chatCore.getChats();
                const targetAI = selectedAIs[0];
                const exist = existingChats.find(c => {
                     // Check if it's a private chat (1 member) and member ID matches
                     return c.members.length === 1 && c.members[0].id === targetAI.id;
                });
                
                if(exist) {
                    qqApp.closeContactModal();
                    qqApp.switchMainTab('msg');
                    qqApp.openChat(exist.id);
                    return;
                }
            }

            const title = selectedAIs.map(a => a.name).join(', ');
            const chatId = chatCore.createChat(title, selectedAIs, selectedUser);
            
            qqApp.closeContactModal();
            qqApp.switchMainTab('msg');
            qqApp.renderChatList();
            qqApp.openChat(chatId);
        },

        openChat: (chatId) => {
            qqApp.currentChatId = chatId;
            const chat = chatCore.getChats().find(c => c.id === chatId);
            if(!chat) return;

            document.getElementById('chatTitle').innerText = chat.title;
            const win = document.getElementById('winQQChat');
            
            // Apply BG
            if(chat.settings && chat.settings.bg) {
                win.style.backgroundImage = `url(${chat.settings.bg})`;
                win.style.backgroundSize = 'cover';
                win.style.backgroundPosition = 'center';
            } else {
                win.style.backgroundImage = '';
            }
            
            win.classList.add('visible');
            qqApp.renderMessages();
        },

        closeChat: () => {
            document.getElementById('winQQChat').classList.remove('visible');
            qqApp.currentChatId = null;
            chatSettings.close();
            qqApp.renderChatList(); 
        },

        renderMessages: () => {
            if(!qqApp.currentChatId) return;
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            const body = document.getElementById('chatBody');
            body.innerHTML = "";
            
            chat.messages.forEach(msg => {
                const isMe = msg.role === 'user';
                const row = document.createElement('div');
                row.className = `msg-row ${isMe ? 'me' : ''}`;
                
                let avatar = '';
                if(isMe) {
                    avatar = chat.userPersona ? chat.userPersona.avatar : '';
                } else {
                    const sender = chat.members.find(m => m.name === msg.senderName) || chat.members[0];
                    avatar = sender ? sender.avatar : '';
                }

                // Content Logic
                let contentHtml = '';
                if(msg.type === 'image') {
                    // Check if content is URL (Image) or Text (JSON)
                    const isUrl = msg.content.startsWith('http') || msg.content.startsWith('data:image') || msg.content.startsWith('blob:');
                    const inner = isUrl 
                        ? `<img src="${msg.content}" class="chat-img-bubble" onclick="event.stopPropagation(); window.open(this.src)">`
                        : `<div class="chat-json-text">${msg.content}</div>`;

                    contentHtml = `
                        <div class="msg-bubble" style="padding:0; background:transparent; box-shadow:none;">
                            <div class="img-spoiler-box blur" onclick="this.classList.add('revealed')">
                                ${inner}
                            </div>
                        </div>`;
                } else if (msg.type === 'voice') {
                    // 模拟语音条
                    const duration = Math.min(60, Math.max(2, Math.floor(msg.content.length / 3)));
                    contentHtml = `
                        <div class="msg-bubble voice" style="width:${60 + duration * 2}px">
                            <svg class="voice-icon" style="width:16px;height:16px;fill:currentColor;"><use href="#icon-voice"></use></svg>
                            <span class="voice-duration">${duration}"</span>
                        </div>
                        <div class="voice-converted-text" id="v_txt_${msg.id}">${msg.content}</div>
                    `;
                } else {
                    // Standard text bubble with scrollbar (max-height defined in CSS)
                    contentHtml = `<div class="msg-bubble">${msg.content}</div>`;
                }

                row.innerHTML = `
                    <img src="${avatar}" class="msg-avatar" onerror="this.style.background='#ccc'">
                    <div class="msg-content-box" oncontextmenu="event.preventDefault(); qqApp.showMsgMenu('${msg.id}', '${msg.type}', event)">
                        <span class="msg-name">${isMe ? (chat.userPersona?chat.userPersona.name:'我') : (msg.senderName || 'AI')}</span>
                        ${contentHtml}
                    </div>
                `;
                
                // Add long press for mobile (simple simulation)
                let timer;
                const box = row.querySelector('.msg-content-box');
                box.addEventListener('touchstart', (e) => {
                    timer = setTimeout(() => {
                        qqApp.showMsgMenu(msg.id, msg.type, e.touches[0]);
                    }, 600);
                });
                box.addEventListener('touchend', () => clearTimeout(timer));
                
                body.appendChild(row);
            });
            body.scrollTop = body.scrollHeight;
        },

        sendText: () => {
            const txt = document.getElementById('chatInput').value.trim();
            if(!txt || !qqApp.currentChatId) return;
            
            chatCore.addMsg(qqApp.currentChatId, 'user', txt);
            document.getElementById('chatInput').value = "";
            qqApp.renderMessages();
        },

        /* Emoji Logic */
        toggleEmojiPanel: () => {
            document.getElementById('toolsPanel').classList.remove('open');
            const panel = document.getElementById('emojiPanel');
            panel.classList.toggle('open');
            if(panel.classList.contains('open')) {
                qqApp.renderEmojiPanel();
            }
        },
        
        closeEmojiPanel: () => {
            document.getElementById('emojiPanel').classList.remove('open');
        },
        
        closeAllPanels: () => {
            document.getElementById('emojiPanel').classList.remove('open');
            document.getElementById('toolsPanel').classList.remove('open');
        },

        renderEmojiPanel: async () => {
            const list = await db.getAll();
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = "";
            
            if(list.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#ccc; font-size:12px; padding:20px;">暂无表情包<br>请导入</div>`;
                return;
            }

            list.forEach(item => {
                const img = document.createElement('img');
                img.src = item.data;
                img.className = 'emoji-item';
                img.onclick = () => qqApp.sendEmoji(item.data);
                grid.appendChild(img);
            });
        },

        handleEmojiUpload: async (input) => {
            if(!input.files || input.files.length === 0) return;
            const files = Array.from(input.files);
            
            const readFile = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            };

            for(const file of files) {
                const base64 = await readFile(file);
                await db.add({ data: base64, timestamp: Date.now() });
            }
            qqApp.renderEmojiPanel();
            input.value = ""; // Reset
        },

        importEmojiUrl: async () => {
            const str = prompt("请输入表情包链接 (支持多张，用英文逗号 , 分隔)");
            if(str) {
                const urls = str.split(',').map(u => u.trim()).filter(u => u);
                for(const url of urls) {
                     await db.add({ data: url, timestamp: Date.now() });
                }
                qqApp.renderEmojiPanel();
            }
        },

        sendEmoji: (imgSrc) => {
            if(!qqApp.currentChatId) return;
            chatCore.addMsg(qqApp.currentChatId, 'user', imgSrc, 'image');
            qqApp.renderMessages();
            qqApp.closeEmojiPanel();
        },

        clearEmojis: async () => {
            if(confirm("确定清空所有收藏的表情包吗？")) {
                await db.clear();
                qqApp.renderEmojiPanel();
            }
        },

        showMsgMenu: (mid, type, e) => {
            qqApp.selectedMsgId = mid;
            const menu = document.getElementById('msgMenu');
            const btnTrans = document.getElementById('btnTranscribe');
            
            btnTrans.style.display = type === 'voice' ? 'block' : 'none';
            
            const rect = e.target.getBoundingClientRect();
            const winRect = document.getElementById('winQQChat').getBoundingClientRect();
            
            menu.style.top = (rect.top - winRect.top - 40) + 'px'; 
            menu.style.left = (rect.left - winRect.left + rect.width/2) + 'px';
            menu.classList.add('visible');
            
            const closeMenu = () => {
                menu.classList.remove('visible');
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 100);
        },

        hideMsgMenu: () => {
            document.getElementById('msgMenu').classList.remove('visible');
        },

        menuAction: (act) => {
            if(!qqApp.selectedMsgId) return;
            const mid = qqApp.selectedMsgId;
            
            if(act === 'delete') {
                chatCore.deleteMsg(qqApp.currentChatId, mid);
                qqApp.renderMessages();
            } else if (act === 'recall') {
                 chatCore.deleteMsg(qqApp.currentChatId, mid);
                 qqApp.renderMessages();
            } else if (act === 'transcribe') {
                const el = document.getElementById('v_txt_' + mid);
                if(el) el.style.display = 'block';
            } else if (act === 'copy') {
                 const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
                 const msg = chat.messages.find(m => m.id === mid);
                 if(msg && msg.content) {
                     navigator.clipboard.writeText(msg.content).then(() => alert('已复制'));
                 }
            } else if (act === 'edit') {
                 const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
                 const msg = chat.messages.find(m => m.id === mid);
                 if(msg && msg.type === 'text') {
                     const newTxt = prompt("编辑消息内容", msg.content);
                     if(newTxt !== null) {
                         chatCore.editMsg(qqApp.currentChatId, mid, newTxt);
                         qqApp.renderMessages();
                     }
                 } else {
                     alert("仅支持编辑文本消息");
                 }
            }
            qqApp.hideMsgMenu();
        },

        triggerReRoll: () => {
            if(!qqApp.currentChatId) return;
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            if(!chat || chat.messages.length === 0) return;
            
            // 改良逻辑：移除末尾所有连续的 AI 消息 (User requested: remove ALL of the last AI response bubbles)
            let removedCount = 0;
            while(chat.messages.length > 0) {
                const lastMsg = chat.messages[chat.messages.length - 1];
                if(lastMsg.role === 'assistant') {
                    chat.messages.pop();
                    removedCount++;
                } else {
                    break; // 遇到用户消息或系统消息则停止
                }
            }
            
            if(removedCount > 0) {
                 // Re-save entire chats list
                 const allChats = chatCore.getChats();
                 const targetChat = allChats.find(c => c.id === qqApp.currentChatId);
                 if(targetChat) {
                     targetChat.messages = chat.messages;
                     chatCore.saveChats(allChats);
                 }
                 
                 qqApp.renderMessages();
                 
                 // Trigger AI again
                 qqApp.triggerAI();
                 chatTools.closeTool(); // Close panel if open
            } else {
                alert("未检测到末尾的AI回复，无法重Roll (请确保最后一条是AI发的)");
            }
        },

        triggerAI: async (options = {}) => {
            if(!qqApp.currentChatId) return;
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            
            if(!cfg.url || !cfg.key) return alert('请先去[设置]配置API信息');

            const btn = document.getElementById('btnAI');
            if(btn) btn.classList.add('loading');

            const wbList = JSON.parse(localStorage.getItem('worldbook_data') || '[]');
            const wbPrompt = wbList.filter(i => i.enabled).map(i => `[${i.title}]: ${i.content}`).join('\n');
            
            // Check if AI should read emoji content
            const readEmoji = document.getElementById('tg_ai_emoji').checked;

            const sysPrompt = {
                role: 'system',
                content: `你现在扮演: ${chat.members.map(m => m.name).join(' 和 ')}。
                用户的身份是: ${chat.userPersona ? chat.userPersona.name : '用户'}。
                ${wbPrompt ? '【世界书/补充设定】\n' + wbPrompt + '\n' : ''}
                

                【重要指令】
                1. 必须且只能返回一个标准的 JSON 数组字符串。
                2. 严禁包含 Markdown 标记（如 \`\`\`json ... \`\`\`）。
                3. 严禁包含任何 JSON 之外的对话文本。
                4. 如果需要发送表情包，请使用 type="image" 并将 content 设置为图片URL。
                
                JSON格式示例: 
                [{"role":"assistant", "senderName":"${chat.members[0].name}", "content":"你好", "type":"text"}]
                
                【语音消息指令】
                如果你想发送语音，请在 JSON 中设置 "type": "voice"，并将 "content" 设置为语音的文本内容（用户界面上会显示为语音条，点击转文字可看到此内容）。
                
                【重要限制】
                1. 严禁描写任何“线下”动作（如：揉了揉你的头、递给你一杯水、把你抱到床上、眼神变得温柔）。
                2. 所有互动必须严格限制在“线上聊天”的语境中（如：发了一个摸摸头的表情包、拍了拍你、发送了一张照片、发了一条语音）。
                3. 你只是手机里的一个 AI 或网友，无法触碰用户实体。
                4. 不要描述你的面部表情或肢体动作，因为用户看不见。只能描述你发送的文字、表情包或语音内容。
                5. 如果你想表达动作，请用 *发送了...的表情包* 或 *发语音说...* 来代替。`
            };
            
            const history = chat.messages.slice(-10).map(m => {
                let content = m.content;
                if(m.type === 'image') {
                    // Check if content is base64 or URL
                    const isBase64 = content.startsWith('data:image');
                    if(readEmoji) {
                        // Send content (base64 or URL) to AI
                        // Note: Some APIs might not support base64 directly in text content, but we send it as text here for now or description
                        // Ideally for vision models we use specific format, but here we assume text-based context
                        // If it's base64, it might be too long. Let's send a placeholder if it's too long, or "Sent an image"
                        if(isBase64) content = "[发送了一张图片/表情包]";
                        else content = `[发送了一张图片: ${content}]`;
                    } else {
                        content = "[表情包]";
                    }
                }
                
                return {
                    role: m.role,
                    content: `${m.senderName ? '['+m.senderName+']: ' : ''}${content}`
                };
            });

            try {
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";

                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({
                        model: cfg.model || 'gpt-3.5-turbo',
                        messages: [sysPrompt, ...history],
                        stream: false,
                        temperature: 0.8
                    })
                });
                
                const data = await res.json();
                if(data.choices && data.choices[0]) {
                    let content = data.choices[0].message.content;
                    try {
                        content = content.replace(/```json/g, '').replace(/```/g, '');
                        const arr = JSON.parse(content);
                        if(Array.isArray(arr)) {
                            arr.forEach(m => {
                                chatCore.addMsg(qqApp.currentChatId, 'assistant', m.content, m.type || 'text', m.senderName || chat.members[0].name);
                            });
                        } else {
                             chatCore.addMsg(qqApp.currentChatId, 'assistant', arr.content || content, 'text', arr.senderName || chat.members[0].name);
                        }
                    } catch(e) {
                        chatCore.addMsg(qqApp.currentChatId, 'assistant', content, 'text', chat.members[0].name);
                    }
                    
                    qqApp.renderMessages();
                    qqApp.renderChatList();
                    
                    // Callback for Call UI
                    if(options.callback) {
                        let finalTxt = content;
                        try {
                             const parsed = JSON.parse(content);
                             if(Array.isArray(parsed)) finalTxt = parsed[0].content;
                             else finalTxt = parsed.content || content;
                        } catch(e){}
                        options.callback(finalTxt);
                    }
                }

            } catch(e) {
                console.error(e);
                alert('API Request Fail: ' + e.message);
            } finally {
                if(btn) btn.classList.remove('loading');
            }
        }
    };

    /* ========================================================
       PERSONA APP LOGIC
       ======================================================== */
    /* ==================== PERSONA APP LOGIC (升级版：支持编辑) ==================== */
const personaApp = {
    currentTab: 'ai', // 'ai' or 'user'
    currentAvatarBase64: null,
    editingId: null, // 记录当前正在编辑的ID，如果是null代表是新建
    
    switchTab: (tab) => {
        personaApp.currentTab = tab;
        document.getElementById('tabAI').className = `psn-tab ${tab==='ai'?'active':''}`;
        document.getElementById('tabUser').className = `psn-tab ${tab==='user'?'active-u':''}`;
        personaApp.renderList();
    },
    
    renderList: () => {
        const list = personaApp.currentTab === 'ai' ? chatCore.getAIs() : chatCore.getUsers();
        const container = document.getElementById('psnList');
        container.innerHTML = "";
        
        if (list.length === 0) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#ccc; margin-top:50px; font-size:12px;">暂无${personaApp.currentTab==='ai'?'AI':'User'}人设<br>点右下角添加</div>`;
            return;
        }
        
        list.forEach(item => {
            const card = document.createElement('div');
            card.className = 'psn-card';
            // ⭐ 核心修改：点击卡片触发编辑
            card.onclick = () => personaApp.openEditModal(item.id);
            card.innerHTML = `
                <img src="${item.avatar || ''}" class="psn-card-img" onerror="this.style.background='#eee'">
                <div class="psn-card-name">${item.name}</div>
                <div class="psn-card-desc">${item.desc}</div>
            `;
            container.appendChild(card);
        });
    },
    
    // 打开新建模式
    openCreateModal: () => {
        personaApp.editingId = null; // 标记为新建
        document.getElementById('createTitle').innerText = `新建 ${personaApp.currentTab==='ai'?'AI':'User'} 人设`;
        
        // 重置表单
        document.getElementById('pName').value = "";
        document.getElementById('pDesc').value = "";
        document.getElementById('pAvatarPreview').src = "";
        document.getElementById('pAvatarBox').classList.remove('has-img');
        personaApp.currentAvatarBase64 = null;
        
        // 按钮状态
        document.getElementById('btnPsnCancel').style.display = 'block';
        document.getElementById('btnPsnDelete').style.display = 'none';
        
        document.getElementById('modalCreatePersona').classList.add('visible');
    },
    
    // 打开编辑模式
    openEditModal: (id) => {
        const list = personaApp.currentTab === 'ai' ? chatCore.getAIs() : chatCore.getUsers();
        const target = list.find(i => i.id === id);
        if (!target) return;
        
        personaApp.editingId = id; // 标记为编辑
        document.getElementById('createTitle').innerText = "编辑人设";
        
        // 填充旧数据
        document.getElementById('pName').value = target.name;
        document.getElementById('pDesc').value = target.desc;
        
        // 处理头像
        if (target.avatar) {
            document.getElementById('pAvatarPreview').src = target.avatar;
            document.getElementById('pAvatarBox').classList.add('has-img');
            personaApp.currentAvatarBase64 = target.avatar;
        } else {
            document.getElementById('pAvatarPreview').src = "";
            document.getElementById('pAvatarBox').classList.remove('has-img');
            personaApp.currentAvatarBase64 = null;
        }
        
        // 显示删除按钮
        document.getElementById('btnPsnCancel').style.display = 'none';
        document.getElementById('btnPsnDelete').style.display = 'block';
        
        document.getElementById('modalCreatePersona').classList.add('visible');
    },
    
    closeCreateModal: () => {
        document.getElementById('modalCreatePersona').classList.remove('visible');
    },
    
    handleFile: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                personaApp.currentAvatarBase64 = e.target.result;
                document.getElementById('pAvatarPreview').src = e.target.result;
                document.getElementById('pAvatarBox').classList.add('has-img');
            }
            reader.readAsDataURL(input.files[0]);
        }
    },
    
    // 保存逻辑（区分新建和修改）
    savePersona: () => {
        const name = document.getElementById('pName').value.trim();
        const desc = document.getElementById('pDesc').value.trim();
        
        if (!name) return alert('请输入名字');
        
        // 获取当前列表
        let list = personaApp.currentTab === 'ai' ? chatCore.getAIs() : chatCore.getUsers();
        
        if (personaApp.editingId) {
            // === 修改模式 ===
            const index = list.findIndex(i => i.id === personaApp.editingId);
            if (index !== -1) {
                list[index].name = name;
                list[index].desc = desc;
                if (personaApp.currentAvatarBase64) {
                    list[index].avatar = personaApp.currentAvatarBase64;
                }
            }
        } else {
            // === 新建模式 ===
            const newItem = {
                id: (personaApp.currentTab === 'ai' ? 'ai_' : 'user_') + Date.now(),
                name: name,
                desc: desc,
                avatar: personaApp.currentAvatarBase64
            };
            list.push(newItem);
        }
        
        // 保存回 LocalStorage
        if (personaApp.currentTab === 'ai') {
            localStorage.setItem('saved_ai_personas', JSON.stringify(list));
        } else {
            localStorage.setItem('saved_user_personas', JSON.stringify(list));
        }
        
        personaApp.closeCreateModal();
        personaApp.renderList();
    },
    
    // 删除逻辑
    deletePersona: () => {
        if (!personaApp.editingId) return;
        if (confirm("确定要删除这个人设吗？此操作无法撤销。")) {
            let list = personaApp.currentTab === 'ai' ? chatCore.getAIs() : chatCore.getUsers();
            // 过滤掉当前ID
            list = list.filter(i => i.id !== personaApp.editingId);
            
            // 保存
            if (personaApp.currentTab === 'ai') {
                localStorage.setItem('saved_ai_personas', JSON.stringify(list));
            } else {
                localStorage.setItem('saved_user_personas', JSON.stringify(list));
            }
            
            personaApp.closeCreateModal();
            personaApp.renderList();
        }
    }
};

    /* ========================================================
       WORLDBOOK APP LOGIC (New!)
       ======================================================== */
    /* ==================== WORLDBOOK APP LOGIC (支持文件导入版) ==================== */
const wbApp = {
    getData: () => JSON.parse(localStorage.getItem('worldbook_data') || '[]'),
    
    renderList: () => {
        const list = wbApp.getData();
        const container = document.getElementById('wbList');
        container.innerHTML = "";
        
        if (list.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#ccc; margin-top:50px; font-size:12px;">暂无世界书条目<br>点击右下角添加</div>`;
            return;
        }
        
        list.forEach(item => {
            const card = document.createElement('div');
            card.className = `wb-card ${item.enabled ? 'active' : ''}`;
            card.onclick = () => wbApp.toggleStatus(item.id);
            card.innerHTML = `
                <div class="wb-header">
                    <span class="wb-title">${item.title}</span>
                    <span class="wb-status">${item.enabled ? '已启用' : '已关闭'}</span>
                </div>
                <div class="wb-content">${item.content}</div>
            `;
            container.appendChild(card);
        });
    },
    
    toggleStatus: (id) => {
        const list = wbApp.getData();
        const item = list.find(i => i.id === id);
        if (item) {
            item.enabled = !item.enabled;
            localStorage.setItem('worldbook_data', JSON.stringify(list));
            wbApp.renderList();
        }
    },
    
    openCreateModal: () => {
        document.getElementById('wbName').value = "";
        document.getElementById('wbContent').value = "";
        document.getElementById('modalCreateWB').classList.add('visible');
    },
    
    closeCreateModal: () => {
        document.getElementById('modalCreateWB').classList.remove('visible');
    },
    
    // ⭐ 新增：处理文件导入逻辑
    handleImport: (input) => {
        const file = input.files[0];
        if (!file) return;
        
        // 自动填充标题（去掉文件后缀）
        const fileName = file.name.replace(/\.[^/.]+$/, "");
        document.getElementById('wbName').value = fileName;
        document.getElementById('wbContent').value = "正在读取文件...";
        
        const reader = new FileReader();
        
        // 1. 处理 Word 文档 (.docx)
        if (file.name.endsWith('.docx')) {
            reader.onload = (e) => {
                const arrayBuffer = e.target.result;
                // 使用 mammoth 插件解析 docx
                if (window.mammoth) {
                    mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                        .then(result => {
                            document.getElementById('wbContent').value = result.value;
                        })
                        .catch(err => {
                            alert("Word解析失败: " + err.message);
                            document.getElementById('wbContent').value = "";
                        });
                } else {
                    alert("错误：未检测到 mammoth 组件，无法解析 docx。请确保已添加第一步的 script 标签。");
                }
            };
            reader.readAsArrayBuffer(file);
        }
        // 2. 处理文本文件 (.txt / .json)
        else {
            reader.onload = (e) => {
                document.getElementById('wbContent').value = e.target.result;
            };
            reader.readAsText(file);
        }
        
        // 清空 input 防止重复上传无法触发
        input.value = '';
    },
    
    saveEntry: () => {
        const title = document.getElementById('wbName').value.trim();
        const content = document.getElementById('wbContent').value.trim();
        
        if (!title) return alert('请输入条目名');
        if (!content) return alert('请输入内容');
        
        const list = wbApp.getData();
        list.push({
            id: 'wb_' + Date.now(),
            title: title,
            content: content,
            enabled: true
        });
        localStorage.setItem('worldbook_data', JSON.stringify(list));
        
        wbApp.closeCreateModal();
        wbApp.renderList();
    }
};

    /* ========================================================
       THEME & BEAUTIFY MANAGER
       ======================================================== */
    /* ========================================================
       WEIBO APP LOGIC (AI Generated)
       ======================================================== */
    const weiboApp = {
        homePosts: [], // Cache
        followPosts: [], // Cache
        hotSearches: [], // Cache
        currentTab: 'home',
        pubImage: null,
        
        open: () => {
            weiboApp.switchTab('home');
        },

        switchTab: (tab) => {
            weiboApp.currentTab = tab;
            document.getElementById('wbTabHome').className = `wb-nav-tab ${tab==='home'?'active':''}`;
            document.getElementById('wbTabHot').className = `wb-nav-tab ${tab==='hot'?'active':''}`;
            document.getElementById('wbTabFollow').className = `wb-nav-tab ${tab==='follow'?'active':''}`;
            
            document.getElementById('weiboHome').style.display = tab==='home' ? 'block' : 'none';
            document.getElementById('weiboHotSearch').style.display = tab==='hot' ? 'block' : 'none';
            document.getElementById('weiboFollow').style.display = tab==='follow' ? 'block' : 'none';

            if(tab === 'home') {
                if(weiboApp.homePosts.length === 0) weiboApp.renderEmptyState('home');
                else weiboApp.renderFeed('home');
            }
            if(tab === 'follow') {
                if(weiboApp.followPosts.length === 0) weiboApp.renderEmptyState('follow');
                else weiboApp.renderFeed('follow');
            }
            if(tab === 'hot') {
                if(weiboApp.hotSearches.length === 0) weiboApp.renderEmptyState('hot');
                else weiboApp.renderHotSearch();
            }
        },

        renderEmptyState: (type) => {
            const el = document.getElementById(
                type === 'hot' ? 'weiboHotSearch' : (type === 'home' ? 'weiboHome' : 'weiboFollow')
            );
            let btnText = "开始生成";
            let subText = "AI 将为您实时创作内容";
            let onClick = "";
            
            if(type === 'hot') {
                btnText = "生成热搜榜";
                onClick = "weiboApp.generateHotSearch()";
            } else if (type === 'home') {
                btnText = "生成首页推荐";
                onClick = "weiboApp.generateFeed('home')";
            } else {
                btnText = "生成关注动态";
                onClick = "weiboApp.generateFeed('follow')";
            }

            el.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding-top:100px; gap:15px;">
                    <div style="font-size:40px; color:#ddd;">🤖</div>
                    <div style="color:#999; font-size:14px;">${subText}</div>
                    <button class="btn-action" style="background:#ff8200; padding:8px 20px; font-size:14px; border-radius:20px;" onclick="${onClick}">${btnText}</button>
                </div>
            `;
        },

        generateHotSearch: async () => {
            const el = document.getElementById('weiboHotSearch');
            el.innerHTML = `<div style="padding:50px; text-align:center; color:#999;">正在实时抓取热搜...<br><span style="font-size:12px;">(AI 生成中)</span></div>`;
            
            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            if(!cfg.url || !cfg.key) return;

            const prompt = `
            请生成 12-15 条“微博热搜”榜单。
            
            【核心要求】：
            1. 所有的明星名字、电视剧名、综艺名必须是**完全虚构**的（例如：来自二次元、游戏、或者完全编造的名字）。
            2. **严禁出现任何现实世界存在的真人明星**。
            3. 风格要模仿真实热搜（八卦、宣发、吃瓜），但主体必须是虚拟人物。
            
            包含类别：
               - 虚拟明星八卦（恋爱/分手/新剧/红毯造型）
               - 奇葩新闻/暖心瞬间/争议话题
               - 搞笑/梗
            
            必须包含 1 个“爆”点话题。
            
            返回 JSON 数组格式：
            [
                {
                    "rank": 1,
                    "keyword": "热搜关键词",
                    "heat": "1234w", (热度值，带w)
                    "tag": "爆" (可选值: 爆, 新, 热, 荐, 或空字符串)
                }
            ]
            严禁 Markdown，只回 JSON。
            `;

            try {
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";

                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({
                        model: cfg.model || 'gpt-3.5-turbo',
                        messages: [{role: "system", content: "Weibo Hot Search Generator"}, {role: "user", content: prompt}],
                        temperature: 1.0
                    })
                });

                const data = await res.json();
                let content = data.choices[0].message.content;
                content = content.replace(/```json/g, '').replace(/```/g, '');
                weiboApp.hotSearches = JSON.parse(content);
                weiboApp.renderHotSearch();

            } catch(e) {
                el.innerHTML = `<div style="padding:20px; text-align:center;">热搜加载失败</div>`;
            }
        },

        renderHotSearch: () => {
            const el = document.getElementById('weiboHotSearch');
            el.innerHTML = "";
            
            // Header Image
            const banner = document.createElement('div');
            banner.style.cssText = "height:120px; background:linear-gradient(45deg, #ff9a9e, #fad0c4); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:20px; margin-bottom:10px;";
            banner.innerText = "微博热搜榜";
            el.appendChild(banner);

            weiboApp.hotSearches.forEach(item => {
                const row = document.createElement('div');
                row.className = 'wb-hot-item';
                
                let tagHtml = '';
                if(item.tag) {
                    let cls = 'hot';
                    if(item.tag === '爆') cls = 'bao';
                    if(item.tag === '新') cls = 'new';
                    if(item.tag === '荐') cls = 'rec';
                    tagHtml = `<span class="wb-tag ${cls}">${item.tag}</span>`;
                }

                row.innerHTML = `
                    <div class="wb-rank top-${item.rank}">${item.rank}</div>
                    <div class="wb-topic">${item.keyword}</div>
                    <div class="wb-heat">${item.heat}</div>
                    ${tagHtml}
                `;
                
                row.onclick = () => weiboApp.openTopic(item.keyword);
                el.appendChild(row);
            });
        },

        /* Topic Logic */
        openTopic: async (keyword) => {
            const layer = document.getElementById('winWeiboTopic');
            const body = document.getElementById('weiboTopicBody');
            layer.classList.add('visible');
            
            body.innerHTML = `
                <div class="wb-topic-header">
                    <div class="wb-topic-title">#${keyword}#</div>
                    <div class="wb-topic-read">阅读 ${Math.floor(Math.random()*900+100)}亿 · 讨论 ${Math.floor(Math.random()*90+10)}万</div>
                </div>
                <div style="padding:20px; text-align:center; color:#999;">正在生成话题广场...</div>
            `;

            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            if(!cfg.url || !cfg.key) return;

            const prompt = `生成 5 条关于微博话题 #${keyword}# 的相关微博。
            内容要求：
            1. 包含媒体账号的正式报道。
            2. 包含吃瓜群众的吐槽/玩梗。
            3. 包含粉丝控评或路人观点。
            
            格式 JSON 数组：
            [{ "author": "央视新闻/路人甲", "content": "内容...", "likes": 123 }]
            `;

            try {
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";
                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({ model: cfg.model || 'gpt-3.5-turbo', messages: [{role: "user", content: prompt}] })
                });
                const data = await res.json();
                let content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '');
                const posts = JSON.parse(content);
                
                // Render Topic Feed
                let html = body.innerHTML; // Keep header
                // Remove loading
                html = html.replace('正在生成话题广场...', '');
                
                posts.forEach(p => {
                    const avatar = 'https://ui-avatars.com/api/?background=random&name=' + p.author;
                    html += `
                        <div class="wb-post">
                            <div class="wb-post-header">
                                <img src="${avatar}" class="wb-p-avt">
                                <div class="wb-p-info"><span class="wb-p-name">${p.author}</span></div>
                            </div>
                            <div class="wb-p-content">${p.content}</div>
                            <div class="wb-p-footer"><span>👍 ${p.likes}</span></div>
                        </div>
                    `;
                });
                body.innerHTML = html;

            } catch(e) { console.error(e); }
        },

        /* Profile Logic */
        openProfile: (name, isAi=false) => {
            const layer = document.getElementById('winWeiboProfile');
            const body = document.getElementById('weiboProfileBody');
            layer.classList.add('visible');
            
            // Get Info
            let avatar = 'https://ui-avatars.com/api/?background=random&name=' + name;
            let desc = '这个人很懒，什么都没有写';
            let posts = [];

            if(isAi) {
                const char = chatCore.getAIs().find(c => c.name === name) || chatCore.getUsers().find(c => c.name === name);
                if(char) {
                    if(char.avatar) avatar = char.avatar;
                    if(char.desc) desc = char.desc;
                }
            }
            
            // Filter existing posts by this author from cache
            const myPosts = weiboApp.posts.filter(p => p.author === name);

            body.innerHTML = `
                <div class="wb-prof-header" style="background-image:url('https://picsum.photos/400/200?random=${name}')">
                    <img src="${avatar}" class="wb-prof-avt">
                </div>
                <div class="wb-prof-info">
                    <div class="wb-prof-nick">${name}</div>
                    <div class="wb-prof-bio">简介：${desc}</div>
                    <div class="wb-prof-stats">
                        <div>123 <span>关注</span></div>
                        <div>45.6w <span>粉丝</span></div>
                    </div>
                </div>
                <div class="wb-nav-tabs" style="background:#fff; padding:0 15px; border-bottom:1px solid #eee; margin-bottom:10px;">
                    <div class="wb-nav-tab active" style="padding:10px 0;">微博</div>
                    <div class="wb-nav-tab" style="padding:10px 0;">视频</div>
                    <div class="wb-nav-tab" style="padding:10px 0;">相册</div>
                </div>
                <div id="wbProfFeed">
                    ${myPosts.length === 0 ? '<div style="text-align:center; padding:30px; color:#999">暂无微博</div>' : ''}
                </div>
            `;
            
            const feed = document.getElementById('wbProfFeed');
            myPosts.forEach(p => {
                 const el = document.createElement('div');
                 el.className = 'wb-post';
                 el.innerHTML = `<div class="wb-p-content">${p.content}</div><div class="wb-p-footer"><span>${p.time}</span><span>👍 ${p.likes}</span></div>`;
                 feed.appendChild(el);
            });
        },

        /* Publish Logic */
        openPublish: () => {
            document.getElementById('wbPubInput').value = "";
            weiboApp.pubImage = null;
            document.getElementById('wbPubPreview').style.display = 'none';
            document.getElementById('modalWeiboPub').classList.add('visible');
        },

        handlePubImage: (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    weiboApp.pubImage = e.target.result;
                    const prev = document.getElementById('wbPubPreview');
                    prev.src = e.target.result;
                    prev.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        doPublish: () => {
            const txt = document.getElementById('wbPubInput').value.trim();
            if(!txt && !weiboApp.pubImage) return;
            
            // Get User
            const users = chatCore.getUsers();
            const me = users[0] || {name: '我', avatar: ''};
            
            const newPost = {
                id: Date.now(),
                author: me.name,
                avatar: me.avatar,
                content: txt,
                image: weiboApp.pubImage,
                time: '刚刚',
                likes: 0,
                comments_count: 0,
                is_ai_char: false,
                comments: []
            };
            
            // Add to both feeds for visibility
            weiboApp.homePosts.unshift(newPost);
            weiboApp.followPosts.unshift(newPost);
            
            weiboApp.renderFeed(weiboApp.currentTab === 'hot' ? 'home' : weiboApp.currentTab);
            document.getElementById('modalWeiboPub').classList.remove('visible');
            
            // Trigger Auto Reply
            setTimeout(() => weiboApp.triggerAutoReply(newPost), 2000);
        },

        triggerAutoReply: async (post) => {
            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            if(!cfg.url || !cfg.key) return;

            const ais = chatCore.getAIs();
            const charNames = ais.map(c => c.name).join(', ');

            const prompt = `
            用户发了一条微博：“${post.content}”。
            
            请生成 3-5 条评论。
            要求：
            1. 其中必须包含一个叫“罗伯特”的机器人账号。
               - 罗伯特特点：经常发一些不知所云、莫名其妙但又有点好笑的话，或者突然升华主题，或者单纯的复读/故障风。
            2. 其他评论可以是角色库中的人（${charNames}）或路人。
            
            JSON: [{"author": "罗伯特", "content": "..."}, {"author": "...", "content": "..."}]
            `;

            try {
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";
                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({ model: cfg.model || 'gpt-3.5-turbo', messages: [{role: "user", content: prompt}] })
                });
                const data = await res.json();
                let content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '');
                const cmts = JSON.parse(content);
                
                // Process avatars
                const finalCmts = cmts.map(c => {
                    let avatar = 'https://ui-avatars.com/api/?background=random&name=' + c.author;
                    if(c.author === '罗伯特') avatar = 'https://api.dicebear.com/7.x/bottts/svg?seed=Robert'; // Robot avatar
                    else {
                        const char = ais.find(x => x.name === c.author);
                        if(char && char.avatar) avatar = char.avatar;
                    }
                    return { ...c, avatar };
                });
                
                post.comments = finalCmts;
                post.comments_count = finalCmts.length;
                weiboApp.renderFeed(); // Update counts
                alert(`收到 ${finalCmts.length} 条新评论！`);

            } catch(e) { console.error(e); }
        },

        closeLayer: (id) => {
            document.getElementById(id).classList.remove('visible');
        },

        generateFeed: async (type) => {
            const ais = chatCore.getAIs();
            const users = chatCore.getUsers();
            const allChars = [...ais, ...users];
            
            const feedEl = document.getElementById(type === 'home' ? 'weiboHome' : 'weiboFollow');
            feedEl.innerHTML = `<div style="padding:50px; text-align:center; color:#999;">正在刷新${type==='home'?'首页':'关注'}...<br><span style="font-size:12px;">AI正在吃瓜...</span></div>`;

            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            if(!cfg.url || !cfg.key) {
                feedEl.innerHTML = `<div style="padding:20px; text-align:center;">请先在设置中配置API</div>`;
                return;
            }

            const charNames = allChars.map(c => c.name + (c.desc ? `(${c.desc})` : '')).join(', ');
            let prompt = "";
            
            if(type === 'home') {
                prompt = `模拟微博首页推荐流。生成 5-8 条微博。
                要求：混合真实网友的吐槽/生活记录（随机网名）、营销号新闻、以及角色库中的人物动态（${charNames}）。内容要极其生活化、真实。`;
            } else {
                prompt = `模拟微博关注流。生成 5-8 条微博。
                要求：**仅限**角色库中的人物（${charNames}）发布。内容必须符合他们的人设。`;
            }
            
            prompt += `
            返回 JSON 数组：
            [{
                "id": 1,
                "author": "名字",
                "is_ai_char": true/false,
                "content": "微博正文",
                "time": "10分钟前",
                "likes": 123,
                "comments_count": 45
            }]
            严禁 Markdown，只输出 JSON。`;

            try {
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";

                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({
                        model: cfg.model || 'gpt-3.5-turbo',
                        messages: [{role: "system", content: "You are a Weibo simulator."}, {role: "user", content: prompt}],
                        temperature: 0.9
                    })
                });

                const data = await res.json();
                let content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '');
                const arr = JSON.parse(content);
                
                const processed = arr.map(p => {
                    let avatar = 'https://ui-avatars.com/api/?background=random&name=' + p.author;
                    if(p.is_ai_char || type === 'follow') { // In follow tab, mostly AI chars
                        const char = allChars.find(c => c.name === p.author);
                        if(char && char.avatar) avatar = char.avatar;
                    }
                    return { ...p, avatar, comments: [] };
                });
                
                if(type === 'home') weiboApp.homePosts = processed;
                else weiboApp.followPosts = processed;
                
                weiboApp.renderFeed(type);

            } catch(e) {
                console.error(e);
                feedEl.innerHTML = `<div style="padding:20px; text-align:center;">刷新失败: ${e.message}</div>`;
            }
        },

        renderFeed: (type) => {
            const feedEl = document.getElementById(type === 'home' ? 'weiboHome' : 'weiboFollow');
            const posts = type === 'home' ? weiboApp.homePosts : weiboApp.followPosts;
            feedEl.innerHTML = "";
            
            posts.forEach((post, idx) => {
                const el = document.createElement('div');
                el.className = 'wb-post';
                el.onclick = () => weiboApp.openDetail(post); // Pass object directly
                el.innerHTML = `
                    <div class="wb-post-header">
                        <img src="${post.avatar}" class="wb-p-avt" onerror="this.style.background='#ccc'" onclick="event.stopPropagation(); weiboApp.openProfile('${post.author}', ${post.is_ai_char})">
                        <div class="wb-p-info">
                            <span class="wb-p-name" onclick="event.stopPropagation(); weiboApp.openProfile('${post.author}', ${post.is_ai_char})">${post.author}</span>
                            <span class="wb-p-time">${post.time} · 来自 iPhone 16 Pro Max</span>
                        </div>
                    </div>
                    <div class="wb-p-content">${post.content}</div>
                    ${post.image ? `<img src="${post.image}" class="wb-p-img">` : ''}
                    <div class="wb-p-footer">
                        <span>↗ 转发</span>
                        <span>💬 ${post.comments_count || 0}</span>
                        <span>👍 ${post.likes}</span>
                    </div>
                `;
                feedEl.appendChild(el);
            });
        },

        openDetail: (post) => {
            if(!post) return;
            
            const detailEl = document.getElementById('winWeiboDetail');
            const body = document.getElementById('weiboDetailBody');
            detailEl.classList.add('visible');
            
            // Render Post itself first
            body.innerHTML = `
                <div class="wb-post" style="margin-bottom:0; border-bottom:10px solid #f2f2f2;">
                    <div class="wb-post-header">
                        <img src="${post.avatar}" class="wb-p-avt">
                        <div class="wb-p-info">
                            <span class="wb-p-name">${post.author}</span>
                            <span class="wb-p-time">${post.time}</span>
                        </div>
                    </div>
                    <div class="wb-p-content" style="font-size:16px;">${post.content}</div>
                    <div class="wb-p-footer">
                        <span>👍 ${post.likes}</span>
                    </div>
                </div>
                <div class="wb-comment-sec-title">评论</div>
                <div id="wbCommentLoading" style="padding:20px; text-align:center; color:#999;">正在加载评论...</div>
                <div id="wbCommentListReal"></div>
            `;
            
            // Trigger Comment Generation
            weiboApp.generateComments(idx);
        },

        closeDetail: () => {
            document.getElementById('winWeiboDetail').classList.remove('visible');
        },

        // RE-WRITING generateComments to accept post object
        generateComments: async (post) => {
            const realList = document.getElementById('wbCommentListReal');
            const loading = document.getElementById('wbCommentLoading');
            
            // If already loaded, show cache
            if(post.comments && post.comments.length > 0) {
                loading.style.display = 'none';
                weiboApp.renderComments(post.comments, realList);
                return;
            }

            const ais = chatCore.getAIs();
            const users = chatCore.getUsers();
            const allChars = [...ais, ...users];
            const charNames = allChars.map(c => c.name).join(', ');

            const prompt = `
            针对这条微博生成 6-10 条评论。
            微博内容：“${post.content}”
            作者：“${post.author}”
            
            【核心要求】：
            1. 模拟真实的微博评论区氛围：
               - 包含“哈哈党”（哈哈哈哈xswl）。
               - 包含“杠精”（就我一个人觉得...？）。
               - 包含“艾特党”（@好友 来看）。
               - 包含“粉丝控评”（抱走我家xx，不约）。
            2. 必须包含角色库中的人物（${charNames}）进行互动，符合人设。
            3. 可选：包含一个叫“罗伯特”的机器人发莫名其妙的文学语录。
            
            JSON格式：
            [
                {"author": "名字", "content": "评论内容", "is_ai_char": true/false}
            ]
            严禁 Markdown，只输出 JSON。
            `;

            try {
                const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";

                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({
                        model: cfg.model || 'gpt-3.5-turbo',
                        messages: [{role: "system", content: "Weibo Comment Generator"}, {role: "user", content: prompt}],
                        temperature: 0.9
                    })
                });

                const data = await res.json();
                let content = data.choices[0].message.content;
                content = content.replace(/```json/g, '').replace(/```/g, '');
                const arr = JSON.parse(content);
                
                // Process avatars
                const comments = arr.map(c => {
                    let avatar = 'https://ui-avatars.com/api/?background=random&name=' + c.author;
                    if(c.is_ai_char) {
                        const char = allChars.find(x => x.name === c.author);
                        if(char && char.avatar) avatar = char.avatar;
                    }
                    return { ...c, avatar };
                });

                post.comments = comments; // Cache
                loading.style.display = 'none';
                weiboApp.renderComments(comments, realList);

            } catch(e) {
                loading.innerText = "评论加载失败";
            }
        },

        renderComments: (list, container) => {
            container.innerHTML = "";
            list.forEach(c => {
                const el = document.createElement('div');
                el.className = 'wb-cmt-item';
                el.innerHTML = `
                    <img src="${c.avatar}" class="wb-cmt-avt">
                    <div class="wb-cmt-box">
                        <div class="wb-cmt-name">${c.author}</div>
                        <div class="wb-cmt-txt">${c.content}</div>
                    </div>
                `;
                container.appendChild(el);
            });
        }
    };

    /* ========================================================
       CALL APP LOGIC (Voice/Video)
       ======================================================== */
    const callApp = {
        mode: 'voice', // 'voice' or 'video'
        isActive: false,
        timer: null,
        seconds: 0,
        
        startCall: (mode) => {
            callApp.mode = mode;
            callApp.isActive = true;
            callApp.seconds = 0;
            
            const layer = document.getElementById('winCallLayer');
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            if(!chat) return alert("请先进入一个聊天窗口");
            
            // Setup UI
            layer.className = `call-layer visible ${mode === 'video' ? 'video-mode' : ''}`;
            
            // Set Avatar/Name
            const users = chatCore.getUsers();
            const me = users[0];
            const other = chat.members[0]; // Assume 1-on-1 for now
            
            document.getElementById('callName').innerText = other ? other.name : 'AI Partner';
            document.getElementById('callAvt').src = other ? other.avatar : '';
            
            // Set Backgrounds
            const settings = chat.settings || {};
            const bgOther = settings.callBgOther || (other ? other.avatar : '') || 'https://picsum.photos/400/800?1';
            const bgMe = settings.callBgMe || (me ? me.avatar : '') || 'https://picsum.photos/400/800?2';
            
            document.getElementById('callBgOther').style.backgroundImage = `url(${bgOther})`;
            document.getElementById('callBgMe').style.backgroundImage = `url(${bgMe})`;
            
            // Reset Elements
            document.getElementById('callChatArea').innerHTML = "";
            document.getElementById('callTimer').innerText = "正在等待对方接受邀请...";
            
            // Simulate Connect
            setTimeout(() => {
                document.getElementById('callTimer').innerText = "00:00";
                callApp.startTimer();
            }, 1500);
        },
        
        endCall: () => {
            callApp.isActive = false;
            clearInterval(callApp.timer);
            document.getElementById('winCallLayer').classList.remove('visible');
        },
        
        startTimer: () => {
            clearInterval(callApp.timer);
            callApp.timer = setInterval(() => {
                callApp.seconds++;
                const m = Math.floor(callApp.seconds / 60).toString().padStart(2, '0');
                const s = (callApp.seconds % 60).toString().padStart(2, '0');
                document.getElementById('callTimer').innerText = `${m}:${s}`;
            }, 1000);
        },
        
        send: () => {
            const input = document.getElementById('callInput');
            const txt = input.value.trim();
            if(!txt) return;
            
            // Add to Chat Core (so it saves in history)
            chatCore.addMsg(qqApp.currentChatId, 'user', txt);
            input.value = "";
            
            // Show Bubble in Call UI immediately
            callApp.renderBubble(txt, true);
            
            // Trigger AI with callback
            qqApp.triggerAI({
                callback: (msgContent) => {
                    callApp.renderBubble(msgContent, false);
                }
            });
        },
        
        renderBubble: (text, isMe) => {
            const area = document.getElementById('callChatArea');
            const row = document.createElement('div');
            row.className = `call-bubble-row ${isMe ? 'me' : 'other'}`;
            row.innerHTML = `<div class="call-bubble">${text}</div>`;
            area.appendChild(row);
            area.scrollTop = area.scrollHeight;
        },
        
        toggleMute: () => {
            alert('麦克风已静音 (模拟)');
        },
        
        toggleSpeaker: () => {
            alert('已切换扬声器 (模拟)');
        },
        
        toggleCamera: () => {
            if(callApp.mode === 'video') {
                // Switch front/back camera simulation
                const bgMe = document.getElementById('callBgMe');
                const bgOther = document.getElementById('callBgOther');
                const tmp = bgMe.style.backgroundImage;
                bgMe.style.backgroundImage = bgOther.style.backgroundImage;
                bgOther.style.backgroundImage = tmp;
            }
        }
    };

    /* ========================================================
       CHAT TOOLS & EXTRAS
       ======================================================== */
    const chatTools = {
        sendUserVoice: () => {
             const txt = prompt("请输入语音内容（将转换为语音条）：");
             if(txt && txt.trim()) {
                 chatCore.addMsg(qqApp.currentChatId, 'user', txt, 'voice');
                 qqApp.renderMessages();
                 chatTools.togglePanel();
             }
        },

        sendImage: () => {
             const desc = prompt("请输入图片描述或内容（将作为AI可见的文本，显示为[图片]）：");
             if(desc && desc.trim()) {
                 // For now, we simulate sending an image by sending text but marking it as image type for display
                 // But since we don't have a real image URL generator, we might just use a placeholder or the text itself
                 // If the user inputs a URL, we use it. If text, we use a placeholder with text.
                 let content = desc.trim();
                 if(!content.startsWith('http')) {
                      content = `https://via.placeholder.com/300x200/e0e0e0/888888?text=${encodeURIComponent(content)}`;
                 }
                 chatCore.addMsg(qqApp.currentChatId, 'user', content, 'image');
                 qqApp.renderMessages();
                 chatTools.togglePanel();
             }
        },

        handlePhoto: (input) => {
             if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    chatCore.addMsg(qqApp.currentChatId, 'user', e.target.result, 'image');
                    qqApp.renderMessages();
                    chatTools.togglePanel();
                };
                reader.readAsDataURL(input.files[0]);
             }
             input.value = "";
        },

        togglePanel: () => {
            document.getElementById('emojiPanel').classList.remove('open');
            document.getElementById('toolsPanel').classList.toggle('open');
        },
        
        closeTool: () => {
            document.getElementById('winGenericTool').classList.remove('visible');
            document.getElementById('winListenTogether').classList.remove('visible');
        },

        openTool: async (type) => {
            chatTools.togglePanel(); // Close panel
            
            if(type === 'music') {
                musicPlayer.open();
                return;
            }

            const layer = document.getElementById('winGenericTool');
            const titleEl = document.getElementById('toolTitle');
            const contentEl = document.getElementById('toolContent');
            layer.classList.add('visible');
            contentEl.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">正在入侵数据...<br><span style="font-size:12px;">AI Generating...</span></div>`;

            let title = "";
            let prompt = "";
            
            // Get current chat member
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            const targetName = chat ? chat.members.map(m=>m.name).join(',') : "目标对象";

            if(type === 'phone') {
                title = "浏览记录";
                prompt = `生成一份“${targetName}”的浏览器浏览记录。包括访问的网站标题、URL（可以是虚构的）和访问时间。格式JSON数组：[{"title":"网站标题", "url":"http://...", "time":"10:00"}]`;
            } else if (type === 'purchase') {
                title = "购买记录";
                prompt = `生成一份“${targetName}”的最近网购记录。包括商品名、价格、购买时间。格式JSON数组：[{"item":"...", "price":"...", "date":"..."}]`;
            } else if (type === 'cart') {
                title = "购物车";
                prompt = `生成一份“${targetName}”的购物车清单。显示未付款的商品。格式JSON数组：[{"item":"...", "price":"..."}]`;
            } else if (type === 'track') {
                title = "查轨迹";
                prompt = `生成一份“${targetName}”的最近行动轨迹。包括时间、地点、事件。格式JSON数组：[{"time":"...", "location":"...", "event":"..."}]`;
            }

            titleEl.innerText = title;

            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            if(!cfg.url || !cfg.key) {
                contentEl.innerHTML = "请先配置API";
                return;
            }

            try {
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";
                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({ model: cfg.model || 'gpt-3.5-turbo', messages: [{role: "user", content: prompt}] })
                });
                const data = await res.json();
                let txt = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '');
                const json = JSON.parse(txt);
                
                let html = "";
                if(Array.isArray(json)) {
                    json.forEach(i => {
                        const mainText = i.item || i.location || i.name || i.title || "未知";
                        const subText = i.date || i.time || i.event || i.url || "";
                        const rightText = i.price || "";

                        html += `<div class="tool-list-item">
                            <div style="flex:1; overflow:hidden; padding-right:5px;">
                                <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${mainText}</div>
                                <div style="font-size:12px; color:#999; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${subText}</div>
                            </div>
                            <div style="color:#ff6b6b; font-size:12px;">${rightText}</div>
                        </div>`;
                    });
                } else if(json.apps) {
                    html += `<div style="padding:10px; font-weight:bold">已安装应用</div><div style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px;">${json.apps.join(', ')}</div>`;
                    html += `<div style="padding:10px; font-weight:bold">通话记录</div>`;
                    json.calls.forEach(c => {
                        html += `<div class="tool-list-item"><span>${c.name}</span><span style="color:#999">${c.time}</span></div>`;
                    });
                    html += `<div style="padding:10px; font-weight:bold">相册</div><div style="background:#fff; padding:10px; border-radius:8px;">${json.gallery}</div>`;
                }
                
                contentEl.innerHTML = html;

            } catch(e) {
                contentEl.innerHTML = "生成失败: " + e.message;
            }
        }
    };

    const musicPlayer = {
        playlist: [],
        currentIndex: 0,
        isPlaying: false,
        audio: null,

        open: () => {
            const layer = document.getElementById('winListenTogether');
            layer.classList.add('visible');
            musicPlayer.audio = document.getElementById('realAudio');
            
            // Set avatars
            const users = chatCore.getUsers();
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            document.getElementById('musicMeAvt').src = users[0] ? users[0].avatar : '';
            document.getElementById('musicOtherAvt').src = (chat && chat.members[0]) ? chat.members[0].avatar : '';

            musicPlayer.render();
        },

        togglePlaylist: () => {
            document.getElementById('musicPlaylistDrawer').classList.toggle('visible');
            musicPlayer.renderPlaylist();
        },

        addUrlSong: () => {
            const url = prompt("请输入歌曲链接 (MP3/M4A URL)");
            if(url) {
                const song = {
                    title: `网络歌曲 ${musicPlayer.playlist.length+1}`,
                    artist: "未知艺术家",
                    url: url.trim(),
                    cover: "https://via.placeholder.com/150/000000/FFFFFF/?text=Music"
                };
                musicPlayer.playlist.push(song);
                if(musicPlayer.playlist.length === 1) musicPlayer.play(0);
                musicPlayer.renderPlaylist();
                musicPlayer.render();
            }
        },

        handleFiles: (input) => {
            if(input.files && input.files.length > 0) {
                const files = Array.from(input.files);
                const list = files.map(f => ({
                    title: f.name.replace(/\.[^/.]+$/, ""),
                    artist: "本地音频",
                    url: URL.createObjectURL(f),
                    cover: "https://via.placeholder.com/150/000000/FFFFFF/?text=Local"
                }));
                const wasEmpty = musicPlayer.playlist.length === 0;
                musicPlayer.playlist.push(...list);
                if(wasEmpty) musicPlayer.play(0);
                else musicPlayer.renderPlaylist();
                musicPlayer.render();
            }
            input.value = "";
        },

        play: (index) => {
            if(index >= 0 && index < musicPlayer.playlist.length) {
                musicPlayer.currentIndex = index;
                const song = musicPlayer.playlist[index];
                musicPlayer.audio.src = song.url;
                musicPlayer.audio.play();
                musicPlayer.isPlaying = true;
                musicPlayer.render();
                musicPlayer.renderPlaylist();
            }
        },

        togglePlay: () => {
            if(musicPlayer.playlist.length === 0) return;
            if(musicPlayer.audio.paused) {
                musicPlayer.audio.play();
                musicPlayer.isPlaying = true;
            } else {
                musicPlayer.audio.pause();
                musicPlayer.isPlaying = false;
            }
            musicPlayer.render();
        },

        prev: () => {
            let idx = musicPlayer.currentIndex - 1;
            if(idx < 0) idx = musicPlayer.playlist.length - 1;
            musicPlayer.play(idx);
        },

        next: () => {
            let idx = musicPlayer.currentIndex + 1;
            if(idx >= musicPlayer.playlist.length) idx = 0;
            musicPlayer.play(idx);
        },

        render: () => {
            const song = musicPlayer.playlist[musicPlayer.currentIndex];
            if(!song) {
                document.getElementById('musicTitle').innerText = "暂无播放";
                document.getElementById('musicArtist').innerText = "请添加歌曲";
                return;
            }
            
            document.getElementById('musicTitle').innerText = song.title;
            document.getElementById('musicArtist').innerText = song.artist;
            document.getElementById('musicCover').src = song.cover;
            document.getElementById('musicBg').style.backgroundImage = `url(${song.cover})`;
            
            const btn = document.getElementById('btnPlay');
            btn.innerText = musicPlayer.isPlaying ? "⏸" : "▶";
            
            const disc = document.getElementById('musicDisc');
            if(musicPlayer.isPlaying) disc.classList.add('playing');
            else disc.classList.remove('playing');
        },

        renderPlaylist: () => {
            const listEl = document.getElementById('mpList');
            document.getElementById('mpCount').innerText = `(${musicPlayer.playlist.length})`;
            listEl.innerHTML = "";
            
            musicPlayer.playlist.forEach((song, i) => {
                const el = document.createElement('div');
                el.className = `mp-item ${i === musicPlayer.currentIndex ? 'active' : ''}`;
                el.onclick = () => musicPlayer.play(i);
                el.innerHTML = `
                    <div class="mp-idx">${i === musicPlayer.currentIndex && musicPlayer.isPlaying ? '♪' : i+1}</div>
                    <div class="mp-info">
                        <div class="mp-s-name">${song.title}</div>
                        <div class="mp-s-art">${song.artist}</div>
                    </div>
                    <div class="mp-del" onclick="event.stopPropagation(); musicPlayer.removeSong(${i})">×</div>
                `;
                listEl.appendChild(el);
            });
        },

        removeSong: (index) => {
            musicPlayer.playlist.splice(index, 1);
            if(index === musicPlayer.currentIndex) {
                musicPlayer.play(index >= musicPlayer.playlist.length ? 0 : index);
            } else if (index < musicPlayer.currentIndex) {
                musicPlayer.currentIndex--;
            }
            musicPlayer.renderPlaylist();
            musicPlayer.render();
        }
    };

    const themeMgr = {
        vars: {
            nav: '--qq-nav-bg',
            bubbleMe: '--bubble-me',
            bubbleOther: '--bubble-other',
            footer: '--footer-bg',
            radius: '--avt-radius'
        },
        
        init: () => {
            const saved = JSON.parse(localStorage.getItem('ui_theme_cfg') || '{}');
            Object.keys(saved).forEach(k => {
                if(saved[k]) document.documentElement.style.setProperty(themeMgr.vars[k], saved[k]);
            });
        },

        save: (key, val) => {
            const saved = JSON.parse(localStorage.getItem('ui_theme_cfg') || '{}');
            saved[key] = val;
            localStorage.setItem('ui_theme_cfg', JSON.stringify(saved));
            document.documentElement.style.setProperty(themeMgr.vars[key], val);
        },

        setUrl: (key, url) => {
            if(!url) return;
            // 判断是否是纯色
            const isColor = url.startsWith('#') || url.startsWith('rgb') || url.startsWith('linear');
            const val = isColor ? url : `url(${url})`;
            themeMgr.save(key, val);
        },

        setFile: (key, input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    themeMgr.save(key, `url(${e.target.result})`);
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        setRadius: (val) => {
            themeMgr.save('radius', val);
        },

        reset: () => {
            if(confirm("重置所有美化设置？")) {
                localStorage.removeItem('ui_theme_cfg');
                localStorage.removeItem('ui_icons_cfg');
                location.reload();
            }
        },

        setIcon: (symId, input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const b64 = e.target.result;
                    const icons = JSON.parse(localStorage.getItem('ui_icons_cfg') || '{}');
                    icons[symId] = b64;
                    localStorage.setItem('ui_icons_cfg', JSON.stringify(icons));
                    themeMgr.applyIcon(symId, b64);
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        applyIcon: (symId, b64) => {
            const sym = document.getElementById(symId);
            if(sym) {
                // Replace content with <image>
                sym.innerHTML = `<image href="${b64}" x="0" y="0" width="24" height="24" preserveAspectRatio="xMidYMid slice" />`;
            }
        },

        initIcons: () => {
             const icons = JSON.parse(localStorage.getItem('ui_icons_cfg') || '{}');
             Object.keys(icons).forEach(k => themeMgr.applyIcon(k, icons[k]));
        }
    };
    
    // Initialize Theme
    themeMgr.init();
    themeMgr.initIcons();
    apis.loadCfg();

    /* ========================================================
       NEW FEATURES LOGIC: Chat Settings & Moments
       ======================================================== */
    
    const chatSettings = {
        open: () => {
            if(!qqApp.currentChatId) return;
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            if(!chat) return;
            
            // 填充数据
            document.getElementById('csTitleVal').innerText = chat.title;
            
            // 渲染成员网格
            const grid = document.getElementById('csMembers');
            let html = '';
            
            // 1. AI 成员
            chat.members.forEach(m => {
                html += `
                    <div class="cs-member">
                        <img src="${m.avatar}" class="cs-m-img" onerror="this.style.background='#ccc'">
                        <span class="cs-m-name">${m.name}</span>
                    </div>
                `;
            });
            
            // 2. 用户自己
            if(chat.userPersona) {
                 html += `
                    <div class="cs-member">
                        <img src="${chat.userPersona.avatar}" class="cs-m-img" onerror="this.style.background='#ccc'">
                        <span class="cs-m-name">${chat.userPersona.name}</span>
                    </div>
                `;
            }
            
            // 3. 添加按钮
            html += `
                <div class="cs-member" onclick="qqApp.showContactModal()">
                    <div class="cs-m-img" style="border:1px dashed #ccc; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:20px;">+</div>
                </div>
            `;
            grid.innerHTML = html;

            // Init Auto Reply UI
            const settings = chat.settings || {};
            const tgReply = document.getElementById('tg_auto_reply');
            const rowFreq = document.getElementById('row_auto_reply_freq');
            const selFreq = document.getElementById('sel_auto_reply_freq');

            if(tgReply) {
                tgReply.checked = !!settings.autoReply;
                rowFreq.style.display = settings.autoReply ? 'flex' : 'none';
                if(settings.autoReplyFreq) selFreq.value = settings.autoReplyFreq;
                else selFreq.value = "600000"; // Default 10 min
            }

            document.getElementById('winChatSet').classList.add('visible');
        },

        close: () => {
             document.getElementById('winChatSet').classList.remove('visible');
        },

        editTitle: () => {
            if(!qqApp.currentChatId) return;
            const chat = chatCore.getChats().find(c => c.id === qqApp.currentChatId);
            const newT = prompt("修改聊天名称", chat.title);
            if(newT && newT.trim()) {
                chatCore.updateChatSettings(qqApp.currentChatId, 'note', newT.trim());
                document.getElementById('csTitleVal').innerText = newT.trim();
                document.getElementById('chatTitle').innerText = newT.trim();
                qqApp.renderChatList();
            }
        },
        
        setBg: () => {
            document.getElementById('csBgInput').click();
        },

        handleBg: (input) => {
             if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    chatCore.updateChatSettings(qqApp.currentChatId, 'bg', res);
                    document.getElementById('winQQChat').style.backgroundImage = `url(${res})`;
                    document.getElementById('winQQChat').style.backgroundSize = 'cover';
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        handleCallBg: (input, type) => {
             if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    const key = type === 'me' ? 'callBgMe' : 'callBgOther';
                    chatCore.updateChatSettings(qqApp.currentChatId, key, res);
                    alert('通话背景已更新');
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        toggleAutoReply: (el) => {
            if(!qqApp.currentChatId) return;
            chatCore.updateChatSettings(qqApp.currentChatId, 'autoReply', el.checked);
            const row = document.getElementById('row_auto_reply_freq');
            if(row) row.style.display = el.checked ? 'flex' : 'none';
            if(el.checked) chatCore.updateChatSettings(qqApp.currentChatId, 'autoReplyTriggered', false);
        },

        changeAutoReplyFreq: (el) => {
            if(!qqApp.currentChatId) return;
            chatCore.updateChatSettings(qqApp.currentChatId, 'autoReplyFreq', parseInt(el.value));
            chatCore.updateChatSettings(qqApp.currentChatId, 'autoReplyTriggered', false);
        },

        clearHistory: () => {
            if(confirm("确定清空聊天记录？")) {
                const chats = chatCore.getChats();
                const chat = chats.find(c => c.id === qqApp.currentChatId);
                if(chat) {
                    chat.messages = [];
                    chatCore.saveChats(chats);
                    qqApp.renderMessages();
                    chatSettings.close();
                }
            }
        },

        deleteChat: () => {
            if(confirm("确定删除好友/退出群聊？此操作不可逆。")) {
                chatCore.deleteChat(qqApp.currentChatId);
                chatSettings.close();
                qqApp.closeChat();
            }
        }
    };

    const qqMoments = {
        // Load Qzone Profile from LS
        getProfile: () => JSON.parse(localStorage.getItem('qz_profile') || '{}'),
        saveProfile: (p) => localStorage.setItem('qz_profile', JSON.stringify(p)),

        render: () => {
            const list = chatCore.getMoments();
            const box = document.getElementById('momentsList');
            box.innerHTML = "";
            
            // 优先读取自定义 Qzone 资料，否则用当前用户人设，否则默认
            const prof = qqMoments.getProfile();
            const users = chatCore.getUsers();
            const me = users[0] || {name: '我', avatar: ''}; // Fallback

            const finalNick = prof.nick || me.name;
            const finalAvt = prof.avatar || me.avatar;
            const finalCover = prof.cover || 'https://picsum.photos/400/300';

            const elNick = document.getElementById('qzNick');
            const elAvt = document.getElementById('qzAvt');
            const elCover = document.getElementById('qzCoverBox');

            if(elNick) elNick.innerText = finalNick;
            if(elAvt) elAvt.src = finalAvt;
            if(elCover) {
                elCover.style.backgroundImage = `url(${finalCover})`;
            }

            if(list.length === 0) {
                box.innerHTML = `<div style="text-align:center; padding:40px; color:#ccc;">这里空空如也<br>快去发第一条动态吧</div>`;
                return;
            }

            list.forEach(m => {
                const el = document.createElement('div');
                el.className = 'moment-item';
                
                // Comments HTML
                let commentsHtml = '';
                if(m.comments && m.comments.length > 0) {
                    commentsHtml = `<div class="m-likes-comments">
                        <div class="m-like-row">${m.likes && m.likes.length ? m.likes.join(', ') : '暂无点赞'}</div>
                        ${m.comments.map(c => `
                            <div class="m-comment-row">
                                <span class="m-c-name">${c.name}:</span>
                                <span class="m-c-txt">${c.content}</span>
                            </div>
                        `).join('')}
                    </div>`;
                }

                el.innerHTML = `
                    <img src="${m.avatar}" class="m-avatar" onerror="this.style.background='#ccc'">
                    <div class="m-content">
                        <div class="m-name">${m.name}</div>
                        <div class="m-text">${m.content}</div>
                        ${m.image ? `<div class="m-imgs"><img src="${m.image}" class="m-img"></div>` : ''}
                        <div class="m-footer">
                            <span>${new Date(m.timestamp).toLocaleString()}</span>
                            <span>💬</span>
                        </div>
                        ${commentsHtml}
                    </div>
                `;
                box.appendChild(el);
            });
        },

        // Customization Methods
        changeCover: () => {
            const choice = prompt("更换封面：\n1. 输入图片链接 (URL)\n2. 上传本地图片");
            if(choice === '1') {
                const url = prompt("请输入图片链接");
                if(url) {
                    const p = qqMoments.getProfile();
                    p.cover = url;
                    qqMoments.saveProfile(p);
                    qqMoments.render();
                }
            } else if (choice === '2') {
                document.getElementById('qzCoverFile').click();
            }
        },
        changeAvatar: () => {
             const choice = prompt("更换Qzone头像：\n1. 输入图片链接 (URL)\n2. 上传本地图片");
             if(choice === '1') {
                const url = prompt("请输入图片链接");
                if(url) {
                    const p = qqMoments.getProfile();
                    p.avatar = url;
                    qqMoments.saveProfile(p);
                    qqMoments.render();
                }
            } else if (choice === '2') {
                document.getElementById('qzAvtFile').click();
            }
        },
        changeNick: () => {
            const p = qqMoments.getProfile();
            const n = prompt("修改昵称", p.nick || "");
            if(n) {
                p.nick = n;
                qqMoments.saveProfile(p);
                qqMoments.render();
            }
        },
        handleFile: (input, type) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const p = qqMoments.getProfile();
                    if(type === 'cover') p.cover = e.target.result;
                    if(type === 'avatar') p.avatar = e.target.result;
                    qqMoments.saveProfile(p);
                    qqMoments.render();
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        openPublish: () => {
            document.getElementById('momInput').value = "";
            document.getElementById('modalPublishMoment').classList.add('visible');
        },
        
        closePublish: () => {
            document.getElementById('modalPublishMoment').classList.remove('visible');
        },

        doPublish: () => {
            const txt = document.getElementById('momInput').value.trim();
            if(!txt) return alert("说点什么吧...");
            
            // 使用 Qzone 的自定义身份发布，或者回落到 User 身份
            const prof = qqMoments.getProfile();
            const users = chatCore.getUsers();
            const me = users[0] || {name: '我', avatar: ''};
            
            const postName = prof.nick || me.name;
            const postAvt = prof.avatar || me.avatar;

            const newMoment = {
                id: 'm_' + Date.now(),
                name: postName,
                avatar: postAvt,
                content: txt,
                image: null, // Image support requires file input in modal, simplified for now
                timestamp: Date.now(),
                likes: [],
                comments: []
            };

            chatCore.addMoment(newMoment);
            qqMoments.closePublish();
            qqMoments.render();

            // Trigger AI Interaction
            setTimeout(() => qqMoments.triggerAIComments(newMoment), 2000);
        },

        triggerAIComments: async (moment) => {
            // Logic: Pick random AI personas to like or comment
            const ais = chatCore.getAIs();
            if(ais.length === 0) return;

            // Randomly select 1-3 AIs
            const activeAIs = ais.sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random() * 3) + 1);
            
            const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
            if(!cfg.url || !cfg.key) return; // Silent fail if no API

            // We will ask AI to generate comments for these selected AIs in one go or loop
            // For simplicity, let's just do one API call asking for a JSON array of comments
            
            const prompt = `
            用户 "${moment.name}" 发了一条动态: "${moment.content}"。
            
            请你扮演以下角色进行互动(点赞或评论):
            ${activeAIs.map(a => `- ${a.name}: ${a.desc}`).join('\n')}
            
            请返回一个JSON数组，包含互动的角色和内容。
            格式示例:
            [
                {"name": "角色A", "action": "like"}, 
                {"name": "角色B", "action": "comment", "content": "哈哈真有趣"}
            ]
            `;

            try {
                let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
                if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";

                const res = await fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                    body: JSON.stringify({
                        model: cfg.model || 'gpt-3.5-turbo',
                        messages: [{role: "system", content: "你是一个社交网络模拟器。"}, {role: "user", content: prompt}],
                        temperature: 0.8
                    })
                });

                const data = await res.json();
                let content = data.choices[0].message.content;
                content = content.replace(/```json/g, '').replace(/```/g, '');
                const actions = JSON.parse(content);
                
                if(Array.isArray(actions)) {
                    // Update data
                    const list = chatCore.getMoments();
                    const target = list.find(m => m.id === moment.id);
                    if(target) {
                        actions.forEach(act => {
                            if(act.action === 'like') {
                                if(!target.likes) target.likes = [];
                                target.likes.push(act.name);
                            } else if (act.action === 'comment') {
                                if(!target.comments) target.comments = [];
                                target.comments.push({name: act.name, content: act.content});
                            }
                        });
                        chatCore.saveMoments(list);
                        qqMoments.render(); // Refresh UI
                    }
                }
            } catch(e) {
                console.warn("AI Moment Fail", e);
            }
        }
    };
 
</script>
<script>
    // Auto Reply Logic
    async function doAutoReply(chatId) {
        const chat = chatCore.getChats().find(c => c.id === chatId);
        if(!chat) return;
        
        const sysPrompt = {
            role: 'system',
            content: `你现在的状态：用户已经很久没理你了。
            任务：主动发起一个新的话题，或者委婉地问用户在干嘛，试图重新建立对话。
            人设：保持你的人设（${chat.members.map(m=>m.name).join(', ')}）。
            要求：
            1. 不要直接说"由于你很久没回复"。
            2. 就像一个真实的朋友那样，发一条消息来"戳"一下用户。
            3. 输出格式必须是 JSON 数组：[{"content": "..."}]`
        };
        
        const cfg = JSON.parse(localStorage.getItem('qq_api_config') || '{}');
        if(!cfg.url || !cfg.key) return;

        try {
            let ep = cfg.url.endsWith('/') ? cfg.url.slice(0,-1) : cfg.url;
            if(!ep.includes('/chat/completions')) ep += "/v1/chat/completions";

            const res = await fetch(ep, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
                body: JSON.stringify({
                    model: cfg.model || 'gpt-3.5-turbo',
                    messages: [sysPrompt], 
                    temperature: 0.9
                })
            });
            
            const data = await res.json();
            if(data.choices && data.choices[0]) {
                let content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '');
                let msgContent = content;
                try {
                    const arr = JSON.parse(content);
                    if(Array.isArray(arr) && arr[0]) msgContent = arr[0].content;
                    else if(arr.content) msgContent = arr.content;
                } catch(e) {}
                
                chatCore.addMsg(chatId, 'assistant', msgContent, 'text', chat.members[0].name);
                qqApp.renderMessages();
                qqApp.renderChatList();
            }
        } catch(e) { console.error("AutoReply Fail", e); }
    }

    // Global Timer
    setInterval(() => {
        const chats = chatCore.getChats();
        const now = Date.now();
        let changed = false;
        
        chats.forEach(chat => {
            const s = chat.settings || {};
            if(s.autoReply && s.autoReplyFreq) {
                // Check if last msg is from AI (user inactive)
                const lastMsg = chat.messages[chat.messages.length-1];
                const isLastAI = lastMsg && lastMsg.role === 'assistant';
                
                if(isLastAI && (now - chat.updatedAt > s.autoReplyFreq)) {
                    if(!s.autoReplyTriggered) {
                        console.log("Wake up AI for", chat.title);
                        s.autoReplyTriggered = true;
                        changed = true;
                        doAutoReply(chat.id);
                    }
                }
            }
        });
        
        if(changed) chatCore.saveChats(chats);
    }, 10000); // Check every 10s
</script>
<script>
    function runCustomCss() {
        var val = document.getElementById('myCustomCss').value;
        localStorage.setItem('my_user_css', val);
        var style = document.getElementById('user-style');
        if(!style) {
            style = document.createElement('style');
            style.id = 'user-style';
            document.head.appendChild(style);
        }
        style.innerText = val;
        var btn = document.querySelector('button[onclick="runCustomCss()"]');
        var oldTxt = btn.innerText;
        btn.innerText = "✅ 已保存";
        setTimeout(function(){ btn.innerText = oldTxt; }, 1000);
    }
    (function(){
        var saved = localStorage.getItem('my_user_css');
        if(saved) {
            var s = document.createElement('style');
            s.id = 'user-style';
            s.innerText = saved;
            document.head.appendChild(s);
            setTimeout(function(){
                var box = document.getElementById('myCustomCss');
                if(box) box.value = saved;
            }, 500);
        }
    })();
</script>


</div></div>
</body></html>
